<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multiple Regression (ANCOVA) ‚Äî Pure JavaScript Edition</title>
  
  <!-- Office.js -->
  <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />

  <style>
    /* === EXACT CSS THEME FROM regression-unified.html === */
    :root{
      --surface-0: #0c1624;
      --surface-1: #1a1f2e;
      --surface-2: #242938;
      --border: #2d3748;
      --accent-1: rgb(255,165,120);
      --accent-2: rgb(120,200,255);
      --accent-3: rgb(152,195,121);
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.8);
      --text-muted: rgba(255,255,255,0.6);
      --panel-radius: 10px;
      --panel-shadow: 0px 4px 20px rgba(0, 0, 0, 0.4);
      --header-color: var(--accent-1);
    }
    
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      background: var(--surface-0);
      color: var(--text-primary);
      font: 14px/1.45 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
    }

    /* === TWO-PANEL LAYOUT === */
    .main-container {
      display: flex;
      height: 100vh;
      gap: 0;
    }

    /* LEFT PANEL - Input */
    .left-panel {
      width: 420px;
      flex-shrink: 0;
      background: var(--surface-1);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* RIGHT PANEL - Results (HIDDEN - using popup instead) */
    .right-panel {
      display: none !important; /* Always hidden - results shown in popup */
    }
    
    /* LEFT PANEL - Always full width (results in popup) */
    .left-panel.full-width {
      flex: 1 !important;
      max-width: 100% !important;
    }

    /* === CARD HEADER === */
    .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: transparent;
      color: var(--header-color);
      padding: 10px 14px;
      font-weight: 600;
      font-size: 1.15rem;
      letter-spacing: 0.3px;
      flex-shrink: 0;
      border-bottom: 1px solid var(--border);
    }

    .card-head i {
      margin-right: 8px;
    }

    /* === LEFT PANEL CONTENT === */
    .left-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* === RIGHT PANEL CONTENT === */
    .right-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    /* Panel Sections */
    .panel-section {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
    }

    .section-title {
      color: var(--accent-1);
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Form Fields */
    .field-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    .field-label {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      min-width: 70px;
    }

    input[type=text], select {
      flex: 1;
      background: var(--surface-0);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      min-height: 32px;
      transition: border-color 0.3s ease;
      font-size: 13px;
    }

    input[type=text]:focus, select:focus {
      outline: none;
      border-color: var(--accent-2);
    }

    /* Buttons */
    .btn {
      background: linear-gradient(135deg, var(--accent-1), #FF6B9D);
      color: #000;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      min-height: 38px;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 165, 120, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.alt {
      background: var(--surface-2);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn.alt:hover {
      background: var(--surface-1);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Variables Table */
    .variables-table-container {
      max-height: 250px; /* ~5 rows at 50px each */
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface-0);
    }

    .variables-table-container::-webkit-scrollbar {
      width: 10px;
    }

    .variables-table-container::-webkit-scrollbar-track {
      background: var(--surface-2);
      border-radius: 6px;
    }

    .variables-table-container::-webkit-scrollbar-thumb {
      background: var(--accent-1);
      border-radius: 6px;
      border: 2px solid var(--surface-2);
    }

    .variables-table-container::-webkit-scrollbar-thumb:hover {
      background: var(--accent-2);
    }

    .variables-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .variables-table thead {
      background: var(--surface-0);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .variables-table th {
      padding: 8px 6px;
      text-align: left;
      font-weight: 700;
      color: var(--accent-1);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border);
    }

    .variables-table th.center {
      text-align: center;
    }

    .variables-table td {
      padding: 8px 6px;
      border-bottom: 1px solid var(--border);
    }

    .variables-table tbody tr:hover {
      background: rgba(255, 165, 120, 0.05);
    }

    .variable-icon {
      font-size: 14px;
      color: var(--accent-2);
    }

    .var-assign-btn {
      padding: 4px 8px;
      font-size: 10px;
      border-radius: 4px;
      border: 1px solid transparent;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      position: relative;
    }

    .var-assign-btn.y {
      background: rgba(255, 165, 120, 0.2);
      color: var(--accent-1);
      border-color: rgba(255, 165, 120, 0.3);
    }

    .var-assign-btn.xn {
      background: rgba(120, 200, 255, 0.2);
      color: var(--accent-2);
      border-color: rgba(120, 200, 255, 0.3);
    }

    .var-assign-btn.xc {
      background: rgba(152, 195, 121, 0.2);
      color: var(--accent-3);
      border-color: rgba(152, 195, 121, 0.3);
    }

    .var-assign-btn:hover {
      transform: scale(1.05);
      opacity: 0.8;
    }

    /* EMPHASIZED ACTIVE STATE */
    .var-assign-btn.active {
      font-weight: 800;
      border-width: 2px;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .var-assign-btn.y.active {
      background: rgba(255, 165, 120, 0.5);
      border-color: var(--accent-1);
      box-shadow: 0 0 12px rgba(255, 165, 120, 0.6);
    }

    .var-assign-btn.xn.active {
      background: rgba(120, 200, 255, 0.5);
      border-color: var(--accent-2);
      box-shadow: 0 0 12px rgba(120, 200, 255, 0.6);
    }

    .var-assign-btn.xc.active {
      background: rgba(152, 195, 121, 0.5);
      border-color: var(--accent-3);
      box-shadow: 0 0 12px rgba(152, 195, 121, 0.6);
    }

    /* Tooltip */
    .var-assign-btn::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-5px);
      background: var(--surface-2);
      color: var(--text-primary);
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s, transform 0.2s;
      z-index: 1000;
      border: 1px solid var(--border);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .var-assign-btn:hover::before {
      opacity: 1;
      transform: translateX(-50%) translateY(-8px);
    }

    /* Bucket Tabs */
    .bucket-tabs {
      display: flex;
      background: var(--surface-0);
      border-bottom: 1px solid var(--border);
    }

    .bucket-tab {
      flex: 1;
      padding: 10px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
    }

    .bucket-tab.active {
      color: var(--text-primary);
    }

    .bucket-tab.y-tab.active {
      border-bottom-color: var(--accent-1);
    }

    .bucket-tab.xn-tab.active {
      border-bottom-color: var(--accent-2);
    }

    .bucket-tab.xc-tab.active {
      border-bottom-color: var(--accent-3);
    }

    .tab-count {
      font-size: 10px;
      opacity: 0.7;
    }

    /* Drop Zones */
    .bucket-panel {
      padding: 10px;
      min-height: 150px;
    }

    .drop-zone {
      min-height: 120px;
      border: 2px dashed var(--border);
      border-radius: 6px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .drop-zone.y-zone {
      border-color: rgba(255, 165, 120, 0.3);
      background: rgba(255, 165, 120, 0.02);
    }

    .drop-zone.xn-zone {
      border-color: rgba(120, 200, 255, 0.3);
      background: rgba(120, 200, 255, 0.02);
    }

    .drop-zone.xc-zone {
      border-color: rgba(152, 195, 121, 0.3);
      background: rgba(152, 195, 121, 0.02);
    }

    .drop-zone-placeholder {
      text-align: center;
      color: var(--text-muted);
      font-size: 12px;
      padding: 40px 10px;
    }

    .assigned-var-chip {
      background: var(--surface-0);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
    }

    .assigned-var-chip .remove-btn {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      border: none;
      border-radius: 4px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 10px;
      font-weight: 700;
    }

    .assigned-var-chip .remove-btn:hover {
      background: rgba(255, 107, 107, 0.4);
    }

    /* Stats Container (Right Panel) */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-panel {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .stat-panel-heading {
      background: var(--surface-2);
      padding: 10px 12px;
      font-weight: 700;
      font-size: 13px;
      color: var(--accent-1);
      border-bottom: 1px solid var(--border);
    }

    .stat-panel-body {
      padding: 12px;
    }

    .stat-field {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat-field:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .stat-value {
      color: var(--text-primary);
      font-weight: 700;
      font-size: 13px;
    }

    /* Regression Tables (Right Panel) */
    .regression-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .regression-table thead {
      background: var(--surface-2);
    }

    .regression-table th {
      padding: 10px 12px;
      text-align: left;
      font-weight: 700;
      color: var(--accent-1);
      font-size: 11px;
      text-transform: uppercase;
      border-bottom: 2px solid var(--border);
    }

    .regression-table td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .regression-table tbody tr:hover {
      background: rgba(255, 165, 120, 0.05);
    }

    .table-container {
      overflow-x: auto;
    }

    /* Dropdown Menu (Right Panel) */
    .dropdown-container {
      position: relative;
    }

    .dropdown-btn {
      background: var(--surface-2);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dropdown-btn:hover {
      background: var(--surface-1);
    }

    .dropdown-arrow {
      font-size: 10px;
      transition: transform 0.3s;
    }

    .dropdown-container.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .dropdown-content {
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      min-width: 200px;
      display: none;
      z-index: 1000;
    }

    .dropdown-container.open .dropdown-content {
      display: block;
    }

    .dropdown-content a {
      display: block;
      padding: 10px 14px;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 12px;
      transition: background 0.2s;
    }

    .dropdown-content a:hover {
      background: var(--surface-1);
    }

    .dropdown-separator {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
    }

    /* Status Message */
    .status-msg {
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 8px;
      display: none;
    }

    .status-msg.success {
      background: rgba(152, 195, 121, 0.2);
      color: var(--accent-3);
      border: 1px solid rgba(152, 195, 121, 0.3);
      display: block;
    }

    .status-msg.error {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      border: 1px solid rgba(255, 107, 107, 0.3);
      display: block;
    }

    .status-msg.info {
      background: rgba(120, 200, 255, 0.2);
      color: var(--accent-2);
      border: 1px solid rgba(120, 200, 255, 0.3);
      display: block;
    }

    /* Loading Spinner */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- LEFT PANEL - INPUT -->
    <div class="left-panel full-width">
      <div class="card-head">
        <span><i class="fa-solid fa-sliders"></i> Multiple Regression (ANCOVA)</span>
        <button class="btn alt" onclick="clearAll()" style="width: auto; padding: 4px 8px; min-height: 28px; font-size: 11px;">
          <i class="fa-solid fa-eraser"></i> Clear All
        </button>
      </div>

      <div class="left-content">
        <!-- Range Selection Panel -->
        <div class="panel-section">
          <div class="section-title">
            <i class="fa-solid fa-database"></i> Pick Data Range
          </div>
          
          <!-- Named Ranges -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 11px; color: var(--text-secondary); font-weight: 600; display: block; margin-bottom: 4px;">üìä Named Ranges</label>
            <select id="rangeSelector" onchange="loadFromNamedRange()">
              <option value="">-- Select Named Range --</option>
            </select>
          </div>

          <!-- Manual Selection -->
          <div style="background: var(--surface-0); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-bottom: 12px;">
            <div style="font-size: 11px; color: var(--text-secondary); font-weight: 600; margin-bottom: 8px;">
              üìç Or Select Cells in Excel
            </div>
            
            <!-- Action buttons -->
            <div style="display: flex; gap: 6px;">
              <button class="btn alt" onclick="autoDetectRange()" style="flex: 1;">
                <i class="fa-solid fa-magic"></i> Auto-detect
              </button>
              <button id="btnUseSelection" class="btn" onclick="useSelection()" style="flex: 2; background: linear-gradient(135deg, var(--accent-2), #4CAF50);" disabled>
                <i class="fa-solid fa-check"></i> Use Selection
              </button>
            </div>
          </div>
          
          <!-- Unified Range Display -->
          <div id="rangeDisplay" style="display: none; background: var(--surface-2); border: 1px solid var(--accent-1); border-radius: 6px; padding: 10px; margin-bottom: 12px; font-size: 11px;">
            <div style="color: var(--accent-1); font-weight: 600; margin-bottom: 6px;">
              <i id="rangeIcon" class="fa-solid fa-bookmark"></i> <span id="rangeTitle"></span>
            </div>
            <div style="color: var(--text-muted); font-size: 10px;">
              <span id="rangeDetails"></span>
            </div>
          </div>
        </div>

        <!-- Variables List Panel -->
        <div class="panel-section variables-panel">
          <div class="section-title">
            <i class="fa-solid fa-list"></i> Available Variables
          </div>

          <div class="variables-table-container">
            <table class="variables-table">
              <thead>
                <tr>
                  <th style="width: 30px;"></th>
                  <th>VARIABLE</th>
                  <th class="center" style="width: 50px;" title="Total observations">N</th>
                  <th class="center" style="width: 50px;" title="Numeric values">nNum</th>
                  <th class="center" style="width: 50px;" title="Categories">nCat</th>
                  <th class="center" style="width: 150px;">ASSIGN TO</th>
                </tr>
              </thead>
              <tbody id="variablesBody">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">
                    No data loaded. Select a range above.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Maximum Usable Cases -->
        <div class="panel-section" style="background: var(--surface-0); border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin-bottom: 12px;">
          <div style="display: flex; align-items: center; gap: 8px; font-size: 11px;">
            <i class="fa-solid fa-database" style="color: var(--accent-2);"></i>
            <span><strong>Maximum Usable Cases:</strong> <span id="maxCases" style="color: var(--accent-2); font-weight: 600;">--</span></span>
          </div>
        </div>

        <!-- Model Assignment Panel (3 Buckets) -->
        <div class="panel-section" style="padding: 0; display: flex; flex-direction: column;">
          <div class="section-title" style="padding: 10px; margin: 0; border-bottom: 1px solid var(--border);">
            <i class="fa-solid fa-chart-line"></i> Model Assignment
          </div>
          
          <!-- Tabs -->
          <div class="bucket-tabs">
            <button class="bucket-tab y-tab active" onclick="switchBucketTab('y')" data-tab="y">
              <span>Y (Response) <span class="tab-count" id="countY">(0)</span></span>
            </button>
            <button class="bucket-tab xn-tab" onclick="switchBucketTab('xn')" data-tab="xn">
              <span>X (numeric) <span class="tab-count" id="countXn">(0)</span></span>
            </button>
            <button class="bucket-tab xc-tab" onclick="switchBucketTab('xc')" data-tab="xc">
              <span>X (Categ.) <span class="tab-count" id="countXc">(0)</span></span>
            </button>
          </div>
          
          <!-- Tab Panels -->
          <div style="flex: 1; position: relative; min-height: 150px;">
            <!-- Y Panel -->
            <div class="bucket-panel active" id="panelY">
              <div class="drop-zone y-zone" id="zoneY">
                <div class="drop-zone-placeholder">
                  üü† Assign a numeric variable as Y (dependent variable)
                </div>
              </div>
            </div>
            
            <!-- Xn Panel -->
            <div class="bucket-panel" id="panelXn" style="display: none;">
              <div class="drop-zone xn-zone" id="zoneXn">
                <div class="drop-zone-placeholder">
                  üîµ Assign numeric independent variables
                </div>
              </div>
            </div>
            
            <!-- Xc Panel -->
            <div class="bucket-panel" id="panelXc" style="display: none;">
              <div class="drop-zone xc-zone" id="zoneXc">
                <div class="drop-zone-placeholder">
                  üü¢ Assign categorical variables
                </div>
              </div>
            </div>
          </div>
          
          <!-- Actions -->
          <div style="padding: 10px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px;">
            <div style="display: flex; gap: 4px;">
              <label style="display: flex; align-items: center; font-size: 12px; flex: 1;">
                <input type="checkbox" id="interceptCheck" checked style="margin-right: 6px;" />
                + Intercept
              </label>
            </div>

            <button class="btn" onclick="runRegression()">
              <i class="fa-solid fa-play"></i> Run Regression
            </button>

            <div id="leftStatus" class="status-msg"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL - RESULTS -->
    <div class="right-panel hidden">
      <div class="card-head">
        <span><i class="fa-solid fa-chart-line"></i> Linear Regression Analysis</span>
        <div class="dropdown-container">
          <button class="dropdown-btn" id="dropdownBtn">
            Navigation Menu
            <span class="dropdown-arrow">‚ñº</span>
          </button>
          <div class="dropdown-content" id="dropdownContent">
            <a href="#" onclick="return false;">Regression Results</a>
            <a href="residual-analysis.html">Residual Analysis</a>
            <a href="diagnostics.html">Diagnostics</a>
            <a href="predictions.html">Predictions</a>
            <div class="dropdown-separator"></div>
            <a href="descriptive-stats.html">Descriptive Statistics</a>
            <a href="correlation-analysis.html">Correlation Analysis</a>
          </div>
        </div>
      </div>

      <div class="right-content">
        <!-- Stats Panels -->
        <div class="stats-container">
          <div class="stat-panel">
            <div class="stat-panel-heading"><i class="fa-solid fa-info-circle"></i> Sample Info</div>
            <div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">Used Obs.:</span>
                <span id="validObs" class="stat-value">--</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Include Intercept?:</span>
                <span id="includeIntercept" class="stat-value">Yes</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Numeric Variables:</span>
                <span id="numNumericVars" class="stat-value">0</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Categorical Variables:</span>
                <span id="numCategoricalVars" class="stat-value">0</span>
              </div>
            </div>
          </div>

          <div class="stat-panel">
            <div class="stat-panel-heading"><i class="fa-solid fa-chart-bar"></i> Model Fit</div>
            <div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">R¬≤:</span>
                <span id="rSquared" class="stat-value">--</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Adjusted R¬≤:</span>
                <span id="adjRSquared" class="stat-value">--</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Root MSE:</span>
                <span id="rootMSE" class="stat-value">--</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">AIC:</span>
                <span id="aic" class="stat-value">--</span>
              </div>
            </div>
          </div>

          <div class="stat-panel">
            <div class="stat-panel-heading"><i class="fa-solid fa-calculator"></i> F-Test</div>
            <div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">F-Statistic:</span>
                <span id="fStatistic" class="stat-value">--</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">P-value:</span>
                <span id="fPValue" class="stat-value">--</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Sum of Squares (Model):</span>
                <span id="ssModel" class="stat-value">--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ANOVA Table -->
        <div class="stat-panel" style="min-width: 100%;">
          <div class="stat-panel-heading"><i class="fa-solid fa-table-cells"></i> Analysis of Variance (ANOVA)</div>
          <div class="stat-panel-body" style="padding: 0;">
            <div class="table-container">
              <table class="regression-table">
                <thead>
                  <tr>
                    <th>Source</th>
                    <th>Sum of Squares</th>
                    <th>df</th>
                    <th>Mean Square</th>
                    <th>F</th>
                    <th>Pr(>F)</th>
                  </tr>
                </thead>
                <tbody id="anovaTableBody">
                  <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">
                      Run regression to see ANOVA table
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Coefficients Table -->
        <div class="stat-panel" style="min-width: 100%;">
          <div class="stat-panel-heading"><i class="fa-solid fa-table"></i> Regression Coefficients</div>
          <div class="stat-panel-body" style="padding: 0;">
            <div class="table-container">
              <table class="regression-table">
                <thead>
                  <tr>
                    <th><i class="fa-solid fa-tag"></i> Variable</th>
                    <th>Estimate</th>
                    <th>Std Error</th>
                    <th>t value</th>
                    <th>Pr(>|t|)</th>
                    <th>CI Lower</th>
                    <th>CI Upper</th>
                  </tr>
                </thead>
                <tbody id="dataTableBody">
                  <tr>
                    <td colspan="7" style="text-align: center; padding: 20px; color: var(--text-muted);">
                      Run regression to see coefficients
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="rightStatus" class="status-msg"></div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================
    const STATE = {
      variables: [],
      assignments: {
        y: null,
        xn: [],
        xc: []
      },
      currentRange: null,
      rawData: {}
    };

    // ============================================================================
    // OFFICE.JS INITIALIZATION
    // ============================================================================
    Office.onReady((info) => {
      if (info.host === Office.HostType.Excel) {
        console.log('‚úÖ Office.js initialized - Pure JavaScript Unified UI ready');
        loadNamedRanges();
        startSelectionMonitor();
      }
    });

    // ============================================================================
    // NAMED RANGES
    // ============================================================================
    function loadNamedRanges() {
      Excel.run(async (context) => {
        const names = context.workbook.names.load('items');
        await context.sync();
        
        const selector = document.getElementById('rangeSelector');
        selector.innerHTML = '<option value="">-- Select Named Range --</option>';
        
        names.items.forEach(name => {
          const option = document.createElement('option');
          option.value = name.name;
          option.textContent = name.name;
          selector.appendChild(option);
        });
        
        console.log(`üìó Loaded ${names.items.length} named ranges`);
      }).catch(error => {
        console.error('Error loading named ranges:', error);
      });
    }

    function loadFromNamedRange() {
      const selector = document.getElementById('rangeSelector');
      const rangeName = selector.value;
      
      if (!rangeName) return;
      
      Excel.run(async (context) => {
        const namedRange = context.workbook.names.getItem(rangeName);
        const range = namedRange.getRange();
        range.load(['address', 'values', 'rowCount', 'columnCount']);
        await context.sync();
        
        showRangeDisplay(rangeName, range.address, true);
        processRangeData(range.values, range.address);
      }).catch(error => {
        showStatus('error', 'Error loading named range: ' + error.message, 'left');
      });
    }

    // ============================================================================
    // SELECTION MONITORING
    // ============================================================================
    let selectionMonitorInterval = null;

    function startSelectionMonitor() {
      if (selectionMonitorInterval) return;
      
      selectionMonitorInterval = setInterval(() => {
        Excel.run(async (context) => {
          const range = context.workbook.getSelectedRange();
          range.load(['address', 'rowCount', 'columnCount']);
          await context.sync();
          
          const btnUseSelection = document.getElementById('btnUseSelection');
          if (range.rowCount > 1 && range.columnCount > 0) {
            btnUseSelection.disabled = false;
            btnUseSelection.textContent = `‚úì Use ${range.address}`;
          } else {
            btnUseSelection.disabled = true;
            btnUseSelection.innerHTML = '<i class="fa-solid fa-check"></i> Use Selection';
          }
        }).catch(() => {
          // Silently fail if Excel is not ready
        });
      }, 500);
    }

    function autoDetectRange() {
      Excel.run(async (context) => {
        const activeCell = context.workbook.getActiveCell();
        const expandedRange = activeCell.getSurroundingRegion();
        expandedRange.load(['address', 'values', 'rowCount', 'columnCount']);
        await context.sync();
        
        showRangeDisplay('Auto-detected', expandedRange.address, false);
        processRangeData(expandedRange.values, expandedRange.address);
      }).catch(error => {
        showStatus('error', 'Auto-detect failed: ' + error.message, 'left');
      });
    }

    function useSelection() {
      Excel.run(async (context) => {
        const range = context.workbook.getSelectedRange();
        range.load(['address', 'values', 'rowCount', 'columnCount']);
        await context.sync();
        
        showRangeDisplay('Manual Selection', range.address, false);
        processRangeData(range.values, range.address);
      }).catch(error => {
        showStatus('error', 'Error using selection: ' + error.message, 'left');
      });
    }

    // ============================================================================
    // RANGE DISPLAY
    // ============================================================================
    function showRangeDisplay(title, address, isNamed) {
      const display = document.getElementById('rangeDisplay');
      const icon = document.getElementById('rangeIcon');
      const titleSpan = document.getElementById('rangeTitle');
      const details = document.getElementById('rangeDetails');
      
      icon.className = isNamed ? 'fa-solid fa-bookmark' : 'fa-solid fa-table-cells';
      titleSpan.textContent = title;
      details.textContent = address;
      display.style.display = 'block';
    }

    // ============================================================================
    // DATA PROCESSING
    // ============================================================================
    function processRangeData(values, address) {
      if (values.length < 2) {
        showStatus('error', 'Range must have at least 2 rows (header + data)', 'left');
        return;
      }
      
      // Extract headers and data
      const headers = values[0];
      const dataRows = values.slice(1);
      
      // Build variables array with enhanced statistics
      STATE.variables = headers.map((header, colIdx) => {
        const columnData = dataRows.map(row => row[colIdx]);
        const validData = columnData.filter(val => val !== null && val !== undefined && val !== '');
        
        // Count numeric vs non-numeric values
        const numericData = validData.filter(val => {
          const num = Number(val);
          return !isNaN(num);
        });
        
        // Get unique values for category count
        const uniqueValues = [...new Set(validData)];
        
        return {
          name: header || `Column${colIdx + 1}`,
          n: validData.length,
          nNum: numericData.length,
          nCat: uniqueValues.length,
          data: columnData,
          colIdx: colIdx
        };
      });
      
      // Store range info
      STATE.currentRange = address;
      
      // Render variables table
      renderVariablesTable();
      updateMaxCases();
      showStatus('success', `‚úì Loaded ${headers.length} variables from ${address}`, 'left');
    }

    function renderVariablesTable() {
      const tbody = document.getElementById('variablesBody');
      tbody.innerHTML = '';
      
      STATE.variables.forEach((variable, idx) => {
        const tr = document.createElement('tr');
        
        // Icon
        const tdIcon = document.createElement('td');
        tdIcon.innerHTML = '<i class="fa-solid fa-database variable-icon"></i>';
        tr.appendChild(tdIcon);
        
        // Name
        const tdName = document.createElement('td');
        tdName.textContent = variable.name;
        tdName.style.fontWeight = '600';
        tr.appendChild(tdName);
        
        // N
        const tdN = document.createElement('td');
        tdN.textContent = variable.n;
        tdN.style.textAlign = 'center';
        tdN.style.color = 'var(--text-secondary)';
        tr.appendChild(tdN);
        
        // nNum (numeric count)
        const tdNNum = document.createElement('td');
        tdNNum.textContent = variable.nNum;
        tdNNum.style.textAlign = 'center';
        tdNNum.style.fontWeight = '600';
        tdNNum.style.color = variable.nNum === variable.n ? 'var(--accent-2)' : 'var(--text-muted)';
        tr.appendChild(tdNNum);
        
        // nCat (unique categories)
        const tdNCat = document.createElement('td');
        tdNCat.textContent = variable.nCat;
        tdNCat.style.textAlign = 'center';
        tdNCat.style.fontWeight = '600';
        // Color based on category count: few = good for categorical, many = numeric
        if (variable.nCat <= 10) {
          tdNCat.style.color = 'var(--accent-3)'; // Green - good for categorical
        } else if (variable.nCat <= 20) {
          tdNCat.style.color = 'var(--accent-1)'; // Orange - borderline
        } else {
          tdNCat.style.color = 'var(--text-muted)'; // Gray - too many for categorical
        }
        tr.appendChild(tdNCat);
        
        // Assign buttons with tooltips
        const tdAssign = document.createElement('td');
        tdAssign.style.textAlign = 'center';
        
        const btnY = document.createElement('button');
        btnY.className = 'var-assign-btn y';
        btnY.textContent = 'Y';
        btnY.setAttribute('data-tooltip', 'Response Variable (Dependent)');
        btnY.onclick = () => assignVariable(idx, 'y');
        if (STATE.assignments.y === variable.name) btnY.classList.add('active');
        
        const btnXn = document.createElement('button');
        btnXn.className = 'var-assign-btn xn';
        btnXn.textContent = 'Xn';
        btnXn.setAttribute('data-tooltip', 'Numeric Predictor');
        btnXn.onclick = () => assignVariable(idx, 'xn');
        if (STATE.assignments.xn.includes(variable.name)) btnXn.classList.add('active');
        
        const btnXc = document.createElement('button');
        btnXc.className = 'var-assign-btn xc';
        btnXc.textContent = 'Xc';
        btnXc.setAttribute('data-tooltip', 'Categorical Predictor');
        btnXc.onclick = () => assignVariable(idx, 'xc');
        if (STATE.assignments.xc.includes(variable.name)) btnXc.classList.add('active');
        
        tdAssign.appendChild(btnY);
        tdAssign.appendChild(document.createTextNode(' '));
        tdAssign.appendChild(btnXn);
        tdAssign.appendChild(document.createTextNode(' '));
        tdAssign.appendChild(btnXc);
        
        tr.appendChild(tdAssign);
        tbody.appendChild(tr);
      });
    }

    // ============================================================================
    // VARIABLE ASSIGNMENT (MUTUALLY EXCLUSIVE)
    // ============================================================================
    function assignVariable(varIdx, bucket) {
      const variable = STATE.variables[varIdx];
      
      // Check if already assigned to THIS specific bucket (for toggle behavior)
      let isAlreadyInThisBucket = false;
      if (bucket === 'y') {
        isAlreadyInThisBucket = STATE.assignments.y === variable.name;
      } else if (bucket === 'xn') {
        isAlreadyInThisBucket = STATE.assignments.xn.includes(variable.name);
      } else if (bucket === 'xc') {
        isAlreadyInThisBucket = STATE.assignments.xc.includes(variable.name);
      }
      
      // Remove from all buckets first (ensures mutual exclusivity)
      removeVariableFromAllAssignments(variable.name);
      
      // If it WASN'T in this bucket, add it (if it WAS, leave it removed - toggle off)
      if (!isAlreadyInThisBucket) {
        if (bucket === 'y') {
          STATE.assignments.y = variable.name;
        } else if (bucket === 'xn') {
          STATE.assignments.xn.push(variable.name);
        } else if (bucket === 'xc') {
          STATE.assignments.xc.push(variable.name);
        }
      }
      
      renderVariablesTable();
      updateBucketDisplay();
      updateMaxCases();
    }
    
    function removeVariableFromAllAssignments(varName) {
      // Remove from Y
      if (STATE.assignments.y === varName) {
        STATE.assignments.y = null;
      }
      
      // Remove from Xn
      const xnIdx = STATE.assignments.xn.indexOf(varName);
      if (xnIdx >= 0) {
        STATE.assignments.xn.splice(xnIdx, 1);
      }
      
      // Remove from Xc
      const xcIdx = STATE.assignments.xc.indexOf(varName);
      if (xcIdx >= 0) {
        STATE.assignments.xc.splice(xcIdx, 1);
      }
    }

    function updateBucketDisplay() {
      // Update counts
      document.getElementById('countY').textContent = `(${STATE.assignments.y ? 1 : 0})`;
      document.getElementById('countXn').textContent = `(${STATE.assignments.xn.length})`;
      document.getElementById('countXc').textContent = `(${STATE.assignments.xc.length})`;
      
      // Update drop zones
      updateDropZone('zoneY', STATE.assignments.y ? [STATE.assignments.y] : [], 'y');
      updateDropZone('zoneXn', STATE.assignments.xn, 'xn');
      updateDropZone('zoneXc', STATE.assignments.xc, 'xc');
    }

    function updateDropZone(zoneId, variables, bucket) {
      const zone = document.getElementById(zoneId);
      zone.innerHTML = '';
      
      if (variables.length === 0) {
        const placeholder = document.createElement('div');
        placeholder.className = 'drop-zone-placeholder';
        placeholder.textContent = bucket === 'y' ? 'üü† Assign a numeric variable as Y (dependent variable)' :
                                  bucket === 'xn' ? 'üîµ Assign numeric independent variables' :
                                  'üü¢ Assign categorical variables';
        zone.appendChild(placeholder);
      } else {
        variables.forEach(varName => {
          const chip = document.createElement('div');
          chip.className = 'assigned-var-chip';
          chip.innerHTML = `
            <span>${varName}</span>
            <button class="remove-btn" onclick="removeAssignment('${varName}', '${bucket}')">‚úï</button>
          `;
          zone.appendChild(chip);
        });
      }
    }

    function removeAssignment(varName, bucket) {
      // Simply remove from all assignments (already exclusive)
      removeVariableFromAllAssignments(varName);
      
      renderVariablesTable();
      updateBucketDisplay();
      updateMaxCases();
    }

    function switchBucketTab(bucket) {
      // Update tab active state
      document.querySelectorAll('.bucket-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.bucket-tab.${bucket}-tab`).classList.add('active');
      
      // Update panel visibility
      document.querySelectorAll('.bucket-panel').forEach(panel => panel.style.display = 'none');
      document.getElementById(`panel${bucket.charAt(0).toUpperCase() + bucket.slice(1)}`).style.display = 'block';
    }

    // ============================================================================
    // MAX CASES
    // ============================================================================
    function updateMaxCases() {
      if (!STATE.assignments.y) {
        document.getElementById('maxCases').textContent = '--';
        return;
      }
      
      const assignedVars = [STATE.assignments.y, ...STATE.assignments.xn, ...STATE.assignments.xc];
      const varsData = STATE.variables.filter(v => assignedVars.includes(v.name));
      
      // Count rows with no missing values
      const numRows = varsData[0].data.length;
      let validCount = 0;
      
      for (let i = 0; i < numRows; i++) {
        const allValid = varsData.every(v => {
          const val = v.data[i];
          return val !== null && val !== undefined && val !== '';
        });
        if (allValid) validCount++;
      }
      
      document.getElementById('maxCases').textContent = validCount;
    }

    // ============================================================================
    // RUN REGRESSION (Using working JS from OLD folder)
    // ============================================================================
    async function runRegression() {
      // Validate
      if (!STATE.assignments.y) {
        showStatus('error', 'Please assign a Y variable', 'left');
        return;
      }
      
      if (STATE.assignments.xn.length === 0 && STATE.assignments.xc.length === 0) {
        showStatus('error', 'Please assign at least one X variable', 'left');
        return;
      }
      
      showStatus('info', '<i class="fa-solid fa-spinner spinner"></i> Running regression...', 'left');
      
      try {
        // Prepare data in the correct format (X as ROWS, not columns)
        const includeIntercept = document.getElementById('interceptCheck').checked;
        const yVar = STATE.variables.find(v => v.name === STATE.assignments.y);
        
        // Collect numeric variables
        const xNumericVars = [];
        const xNumericNames = [];
        STATE.assignments.xn.forEach(varName => {
          const v = STATE.variables.find(v => v.name === varName);
          if (v) {
            xNumericVars.push(v);
            xNumericNames.push(varName);
          }
        });
        
        // Process categorical variables with dummy coding
        const xCategoricalVars = [];
        const xCategoricalNames = [];
        const dummyInfo = {}; // Track dummy variable information
        
        STATE.assignments.xc.forEach(varName => {
          const v = STATE.variables.find(v => v.name === varName);
          if (v) {
            // Get unique categories (excluding null/empty)
            const categories = [...new Set(v.data.filter(val => 
              val !== null && val !== undefined && val !== ''
            ))].sort();
            
            console.log(`üìä Categorical variable "${varName}" has ${categories.length} categories:`, categories);
            
            if (categories.length < 2) {
              throw new Error(`Categorical variable "${varName}" has less than 2 categories. Cannot use in regression.`);
            }
            
            // Create k-1 dummy variables (first category is reference)
            const referenceCategory = categories[0];
            dummyInfo[varName] = {
              reference: referenceCategory,
              categories: categories
            };
            
            for (let i = 1; i < categories.length; i++) {
              const category = categories[i];
              const dummyVar = {
                name: `${varName}_${category}`,
                originalVar: varName,
                category: category,
                data: v.data.map(val => (val === category ? 1 : 0))
              };
              xCategoricalVars.push(dummyVar);
              xCategoricalNames.push(`${varName}=${category}`);
            }
            
            console.log(`   Created ${categories.length - 1} dummy variables (reference: ${referenceCategory})`);
          }
        });
        
        // Combine all X variables (numeric + dummy-coded categorical)
        const allXVars = [...xNumericVars, ...xCategoricalVars];
        const allXNames = [...xNumericNames, ...xCategoricalNames];
        
        // Convert to numeric and build X matrix (each ROW is an observation)
        const Y = [];
        const X = [];
        
        const numObs = yVar.data.length;
        for (let i = 0; i < numObs; i++) {
          const yVal = Number(yVar.data[i]);
          const xRow = allXVars.map(xVar => Number(xVar.data[i]));
          
          // Check for missing values
          const allValid = !isNaN(yVal) && xRow.every(x => !isNaN(x));
          
          if (allValid) {
            Y.push(yVal);
            X.push(xRow);
          }
        }
        
        console.log(`üìä Data prepared: ${Y.length} observations, ${X[0].length} predictors`);
        console.log(`   Numeric variables: ${xNumericNames.length}`);
        console.log(`   Categorical variables: ${STATE.assignments.xc.length} (${xCategoricalVars.length} dummies)`);
        console.log(`   Y: ${Y.length} values`);
        console.log(`   X: ${X.length} rows √ó ${X[0].length} cols`);
        
        // Check for perfect multicollinearity before running regression
        if (X[0].length >= Y.length) {
          throw new Error(`Too many predictors (${X[0].length}) for ${Y.length} observations. Need at least ${X[0].length + 1} observations.`);
        }
        
        // Run regression using working computeOLS function
        const results = computeOLS(X, Y, includeIntercept, 0.05);
        
        // Add variable names and dummy info
        results.yVarName = STATE.assignments.y;
        results.xVarNames = allXNames;
        results.numericVarCount = xNumericNames.length;
        results.categoricalVarCount = STATE.assignments.xc.length;
        results.dummyInfo = dummyInfo;
        
        // Format results for popup and store in localStorage
        formatAndOpenPopup(results);
        
        showStatus('success', `‚úì Regression complete! R¬≤ = ${results.R2.toFixed(4)} - Opening results popup...`, 'left');
        
      } catch (error) {
        console.error('Regression failed:', error);
        showStatus('error', '‚úó Regression failed: ' + error.message, 'left');
      }
    }
    
    // ============================================================================
    // REGRESSION COMPUTATION (Working version from OLD folder)
    // ============================================================================
    function computeOLS(X, Y, includeIntercept, alpha) {
      const n = Y.length;
      const p = X[0].length;
      
      // Add intercept column if requested
      if (includeIntercept) {
        X = X.map(row => [1, ...row]);
      }
      
      const k = X[0].length; // Number of parameters (including intercept if any)
      
      // Compute X'X
      const XtX = matrixMultiply(transpose(X), X);
      
      // Compute (X'X)^-1
      const XtX_inv = matrixInverse(XtX);
      
      // Compute coefficients: Œ≤ = (X'X)^-1 X'Y
      const Xt = transpose(X);
      const XtY = matrixMultiply(Xt, Y.map(y => [y]));
      const beta = matrixMultiply(XtX_inv, XtY).map(row => row[0]);
      
      // Compute fitted values and residuals
      const Y_fit = X.map(row => row.reduce((sum, xi, i) => sum + xi * beta[i], 0));
      const residuals = Y.map((yi, i) => yi - Y_fit[i]);
      
      // Compute sum of squares
      const Y_mean = Y.reduce((sum, y) => sum + y, 0) / n;
      const TSS = Y.reduce((sum, y) => sum + Math.pow(y - Y_mean, 2), 0);
      const SSR = residuals.reduce((sum, r) => sum + r * r, 0);
      const SSE = TSS - SSR;
      
      // R¬≤ and Adjusted R¬≤
      const R2 = 1 - (SSR / TSS);
      const R2_adj = 1 - ((1 - R2) * (n - 1) / (n - k));
      
      // Standard error of regression
      const MSE = SSR / (n - k);
      const RMSE = Math.sqrt(MSE);
      
      // Standard errors of coefficients
      const SE = beta.map((_, i) => Math.sqrt(XtX_inv[i][i] * MSE));
      
      // t-values
      const t_values = beta.map((b, i) => b / SE[i]);
      
      // p-values (two-tailed t-test)
      const df = n - k;
      const p_values = t_values.map(t => 2 * (1 - tCDF(Math.abs(t), df)));
      
      // Confidence intervals
      const t_crit = tInverse(alpha / 2, df);
      const CI_lower = beta.map((b, i) => b - t_crit * SE[i]);
      const CI_upper = beta.map((b, i) => b + t_crit * SE[i]);
      
      // F-statistic
      const F_stat = (SSE / (k - 1)) / (SSR / (n - k));
      const F_pvalue = 1 - fCDF(F_stat, k - 1, n - k);
      
      // AIC and BIC
      const AIC = n * Math.log(SSR / n) + 2 * k;
      const BIC = n * Math.log(SSR / n) + k * Math.log(n);
      
      return {
        coefficients: beta,
        std_errors: SE,
        t_values: t_values,
        p_values: p_values,
        CI_lower: CI_lower,
        CI_upper: CI_upper,
        R2: R2,
        R2_adj: R2_adj,
        RMSE: RMSE,
        MSE: MSE,
        F_stat: F_stat,
        F_pvalue: F_pvalue,
        AIC: AIC,
        BIC: BIC,
        TSS: TSS,
        SSR: SSR,
        SSE: SSE,
        n: n,
        k: k,
        p: p,
        df: df,
        includeIntercept: includeIntercept,
        alpha: alpha,
        residuals: residuals,
        Y_fit: Y_fit
      };
    }
    
    // ============================================================================
    // MATRIX OPERATIONS (Working versions from OLD folder)
    // ============================================================================
    function transpose(matrix) {
      return matrix[0].map((_, colIndex) => matrix.map(row => row[colIndex]));
    }
    
    function matrixMultiply(A, B) {
      const result = [];
      for (let i = 0; i < A.length; i++) {
        result[i] = [];
        for (let j = 0; j < B[0].length; j++) {
          let sum = 0;
          for (let k = 0; k < A[0].length; k++) {
            sum += A[i][k] * B[k][j];
          }
          result[i][j] = sum;
        }
      }
      return result;
    }
    
    function matrixInverse(matrix) {
      const n = matrix.length;
      const augmented = matrix.map((row, i) => [
        ...row,
        ...Array(n).fill(0).map((_, j) => i === j ? 1 : 0)
      ]);
      
      // Gauss-Jordan elimination
      for (let i = 0; i < n; i++) {
        // Find pivot
        let maxRow = i;
        for (let k = i + 1; k < n; k++) {
          if (Math.abs(augmented[k][i]) > Math.abs(augmented[maxRow][i])) {
            maxRow = k;
          }
        }
        [augmented[i], augmented[maxRow]] = [augmented[maxRow], augmented[i]];
        
        // Make diagonal 1
        const divisor = augmented[i][i];
        if (Math.abs(divisor) < 1e-10) {
          throw new Error('Matrix is singular or near-singular - check for multicollinearity');
        }
        for (let j = 0; j < 2 * n; j++) {
          augmented[i][j] /= divisor;
        }
        
        // Eliminate column
        for (let k = 0; k < n; k++) {
          if (k !== i) {
            const factor = augmented[k][i];
            for (let j = 0; j < 2 * n; j++) {
              augmented[k][j] -= factor * augmented[i][j];
            }
          }
        }
      }
      
      // Extract inverse
      return augmented.map(row => row.slice(n));
    }
    
    // ============================================================================
    // STATISTICAL DISTRIBUTION FUNCTIONS
    // ============================================================================
    function tCDF(t, df) {
      // Approximation of Student's t CDF
      const x = df / (df + t * t);
      return 1 - 0.5 * incompleteBeta(df / 2, 0.5, x);
    }
    
    function tInverse(p, df) {
      // Approximation of t critical value
      return Math.sqrt(df * (Math.pow(1 - 2 * p, -2 / df) - 1));
    }
    
    function fCDF(f, df1, df2) {
      // Approximation of F CDF
      const x = df2 / (df2 + df1 * f);
      return 1 - incompleteBeta(df2 / 2, df1 / 2, x);
    }
    
    function incompleteBeta(a, b, x) {
      // Simple approximation
      if (x <= 0) return 0;
      if (x >= 1) return 1;
      return Math.pow(x, a) * Math.pow(1 - x, b) / (a + b);
    }

    // ============================================================================
    // FORMAT AND OPEN POPUP (Replaces right panel display)
    // ============================================================================
    function formatAndOpenPopup(results) {
      console.log('üìä Formatting results for popup...');
      
      // Calculate ANOVA components
      const dfModel = results.k - 1;
      const dfResidual = results.df;
      const dfTotal = results.n - 1;
      const msModel = results.SSE / dfModel;
      const msResidual = results.MSE;
      
      // Format results data for popup
      const resultsData = {
        sampleInfo: {
          usedObs: results.n,
          includeIntercept: results.includeIntercept ? 'Yes' : 'No',
          numericVars: results.numericVarCount || 0,
          categoricalVars: results.categoricalVarCount || 0
        },
        modelFit: {
          rSquared: results.R2.toFixed(4),
          adjRSquared: results.R2_adj.toFixed(4),
          rootMSE: results.RMSE.toFixed(4),
          aic: results.AIC.toFixed(2)
        },
        fTest: {
          fStatistic: results.F_stat.toFixed(4),
          pValue: results.F_pvalue < 0.0001 ? '<0.0001' : results.F_pvalue.toFixed(4),
          ssModel: results.SSE.toFixed(2)
        },
        anovaTable: {
          model: {
            ss: results.SSE.toFixed(4),
            df: dfModel,
            ms: msModel.toFixed(4),
            f: results.F_stat.toFixed(4),
            pValue: results.F_pvalue < 0.0001 ? '<0.0001' : results.F_pvalue.toFixed(4)
          },
          residual: {
            ss: results.SSR.toFixed(4),
            df: dfResidual,
            ms: msResidual.toFixed(4)
          },
          total: {
            ss: results.TSS.toFixed(4),
            df: dfTotal
          }
        },
        coefficients: []
      };
      
      // Format coefficients
      for (let i = 0; i < results.coefficients.length; i++) {
        let varName;
        if (results.includeIntercept) {
          varName = i === 0 ? 'Intercept' : results.xVarNames[i - 1];
        } else {
          varName = results.xVarNames[i];
        }
        
        resultsData.coefficients.push({
          variable: varName,
          estimate: results.coefficients[i].toFixed(4),
          stdError: results.std_errors[i].toFixed(4),
          tValue: results.t_values[i].toFixed(4),
          pValue: results.p_values[i] < 0.0001 ? '<0.0001' : results.p_values[i].toFixed(4),
          ciLower: results.CI_lower[i].toFixed(4),
          ciUpper: results.CI_upper[i].toFixed(4)
        });
      }
      
      // Store in localStorage for popup to access
      localStorage.setItem('regressionResults', JSON.stringify(resultsData));
      console.log('üíæ Results stored in localStorage');
      
      // Open popup dialog
      openResultsPopup();
    }
    
    function openResultsPopup() {
      // Get the dialog URL (same origin)
      const dialogUrl = location.origin + location.pathname.replace(/[^/]*$/, '') + 'regression-results-popup.html';
      
      console.log('üåê Opening results popup...');
      console.log('üìç Dialog URL:', dialogUrl);
      
      // Check if Office.context.ui is available
      if (!Office.context.ui) {
        console.error('‚ùå Office.context.ui is not available!');
        showStatus('error', '‚ùå Dialog API not available - results stored in console', 'left');
        return;
      }
      
      console.log('‚úÖ Office.context.ui available, calling displayDialogAsync...');
      
      Office.context.ui.displayDialogAsync(
        dialogUrl,
        { height: 80, width: 90, displayInIframe: false },
        function(result) {
          if (result.status === Office.AsyncResultStatus.Failed) {
            console.error('‚ùå Failed to open results dialog');
            console.error('‚ùå Error:', result.error.message);
            showStatus('error', '‚ùå Could not open results window: ' + result.error.message, 'left');
          } else {
            console.log('‚úÖ Results dialog opened successfully!');
            window.regressionDialog = result.value;
            showStatus('success', '‚úÖ Results window opened!', 'left');
          }
        }
      );
    }

    // ============================================================================
    // UI CONTROLS
    // ============================================================================
    function clearAll() {
      if (!confirm('Clear all data and assignments?')) return;
      
      STATE.variables = [];
      STATE.assignments = { y: null, xn: [], xc: [] };
      STATE.currentRange = null;
      STATE.rawData = {};
      
      document.getElementById('variablesBody').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--text-muted);">No data loaded. Select a range above.</td></tr>';
      document.getElementById('rangeDisplay').style.display = 'none';
      document.getElementById('rangeSelector').value = '';
      document.getElementById('maxCases').textContent = '--';
      
      updateBucketDisplay();
      showStatus('info', 'All data cleared', 'left');
    }

    // Dropdown toggle
    document.getElementById('dropdownBtn').addEventListener('click', function() {
      document.querySelector('.dropdown-container').classList.toggle('open');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const dropdown = document.querySelector('.dropdown-container');
      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
      }
    });

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    function formatNumber(value, decimals = 4) {
      if (value === null || value === undefined || isNaN(value)) {
        return '---';
      }
      if (Math.abs(value) < 0.0001 && value !== 0) {
        return value.toExponential(2);
      }
      return value.toFixed(decimals);
    }

    function formatPValue(pValue) {
      if (pValue === null || pValue === undefined || isNaN(pValue)) {
        return '---';
      }
      if (pValue < 0.001) {
        return '< 0.001';
      }
      return pValue.toFixed(4);
    }

    function getSignificanceStars(pValue) {
      if (pValue < 0.001) return '***';
      if (pValue < 0.01) return '**';
      if (pValue < 0.05) return '*';
      if (pValue < 0.1) return '.';
      return '';
    }

    function showStatus(type, message, panel) {
      const statusId = panel === 'left' ? 'leftStatus' : 'rightStatus';
      const status = document.getElementById(statusId);
      status.className = `status-msg ${type}`;
      status.innerHTML = message;
      
      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          status.style.display = 'none';
        }, 5000);
      }
    }

    console.log('‚úÖ Pure JavaScript Unified Regression - Ready');
  </script>
</body>
</html>
