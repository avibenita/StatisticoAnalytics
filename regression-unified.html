<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multiple Regression (ANCOVA) â€” Pure JavaScript Edition</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="icon" type="image/png" href="assets/icon2-32.png">
  
  <!-- Office.js -->
  <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />

  <style>
    /* === EXACT CSS THEME FROM regression-unified.html === */
    :root{
      --surface-0: #0c1624;
      --surface-1: #1a1f2e;
      --surface-2: #242938;
      --border: #2d3748;
      --accent-1: rgb(255,165,120);
      --accent-2: rgb(120,200,255);
      --accent-3: rgb(152,195,121);
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.8);
      --text-muted: rgba(255,255,255,0.6);
      --panel-radius: 10px;
      --panel-shadow: 0px 4px 20px rgba(0, 0, 0, 0.4);
      --header-color: var(--accent-1);
    }
    
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      background: var(--surface-0);
      color: var(--text-primary);
      font: 14px/1.45 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
    }

    /* === TWO-PANEL LAYOUT === */
    .main-container {
      display: flex;
      height: 100vh;
      gap: 0;
    }

    /* LEFT PANEL - Input */
    .left-panel {
      width: 420px;
      flex-shrink: 0;
      background: var(--surface-1);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* RIGHT PANEL - Results (HIDDEN - using popup instead) */
    .right-panel {
      display: none !important; /* Always hidden - results shown in popup */
    }
    
    /* LEFT PANEL - Always full width (results in popup) */
    .left-panel.full-width {
      flex: 1 !important;
      max-width: 100% !important;
    }

    /* === CARD HEADER === */
    .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: transparent;
      color: var(--header-color);
      padding: 10px 14px;
      font-weight: 600;
      font-size: 1.15rem;
      letter-spacing: 0.3px;
      flex-shrink: 0;
      border-bottom: 1px solid var(--border);
    }

    .card-head i {
      margin-right: 8px;
    }

    /* === LEFT PANEL CONTENT === */
    .left-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* === RIGHT PANEL CONTENT === */
    .right-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    /* Panel Sections */
    .panel-section {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
    }

    .section-title {
      color: var(--accent-1);
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Form Fields */
    .field-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    .field-label {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      min-width: 70px;
    }

    input[type=text], select {
      flex: 1;
      background: var(--surface-0);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      min-height: 32px;
      transition: border-color 0.3s ease;
      font-size: 13px;
    }

    input[type=text]:focus, select:focus {
      outline: none;
      border-color: var(--accent-2);
    }

    /* Buttons */
    .btn {
      background: linear-gradient(135deg, var(--accent-1), #FF6B9D);
      color: #000;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      min-height: 38px;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 165, 120, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.alt {
      background: var(--surface-2);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn.alt:hover {
      background: var(--surface-1);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Variables Table */
    .variables-table-container {
      max-height: 250px; /* ~5 rows at 50px each */
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface-0);
      position: relative;
      z-index: 1;
    }

    .variables-table-container::-webkit-scrollbar {
      width: 10px;
    }

    .variables-table-container::-webkit-scrollbar-track {
      background: var(--surface-2);
      border-radius: 6px;
    }

    .variables-table-container::-webkit-scrollbar-thumb {
      background: var(--accent-1);
      border-radius: 6px;
      border: 2px solid var(--surface-2);
    }

    .variables-table-container::-webkit-scrollbar-thumb:hover {
      background: var(--accent-2);
    }

    .variables-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .variables-table thead {
      background: var(--surface-0);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .variables-table th {
      padding: 8px 6px;
      text-align: left;
      font-weight: 700;
      color: var(--accent-1);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border);
    }

    .variables-table th.center {
      text-align: center;
    }

    .variables-table td {
      padding: 8px 6px;
      border-bottom: 1px solid var(--border);
    }

    .variables-table tbody tr:hover {
      background: rgba(255, 165, 120, 0.05);
    }

    .variable-icon {
      font-size: 14px;
      color: var(--accent-2);
    }

    .var-assign-btn {
      padding: 4px 8px;
      font-size: 10px;
      border-radius: 4px;
      border: 1px solid transparent;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      position: relative;
    }

    .var-assign-btn.y {
      background: rgba(255, 165, 120, 0.2);
      color: var(--accent-1);
      border-color: rgba(255, 165, 120, 0.3);
    }

    .var-assign-btn.xn {
      background: rgba(120, 200, 255, 0.2);
      color: var(--accent-2);
      border-color: rgba(120, 200, 255, 0.3);
    }

    .var-assign-btn.xc {
      background: rgba(152, 195, 121, 0.2);
      color: var(--accent-3);
      border-color: rgba(152, 195, 121, 0.3);
    }

    .var-assign-btn:hover {
      transform: scale(1.05);
      opacity: 0.8;
    }

    /* EMPHASIZED ACTIVE STATE */
    .var-assign-btn.active {
      font-weight: 800;
      border-width: 2px;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .var-assign-btn.y.active {
      background: rgba(255, 165, 120, 0.5);
      border-color: var(--accent-1);
      box-shadow: 0 0 12px rgba(255, 165, 120, 0.6);
    }

    .var-assign-btn.xn.active {
      background: rgba(120, 200, 255, 0.5);
      border-color: var(--accent-2);
      box-shadow: 0 0 12px rgba(120, 200, 255, 0.6);
    }

    .var-assign-btn.xc.active {
      background: rgba(152, 195, 121, 0.5);
      border-color: var(--accent-3);
      box-shadow: 0 0 12px rgba(152, 195, 121, 0.6);
    }

    /* Tooltip */
    .var-assign-btn::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-5px);
      background: var(--surface-2);
      color: var(--text-primary);
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s, transform 0.2s;
      z-index: 1000;
      border: 1px solid var(--border);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .var-assign-btn:hover::before {
      opacity: 1;
      transform: translateX(-50%) translateY(-8px);
    }

    /* Bucket Tabs */
    /* Variables Assignment Button */
    .vars-assign-btn {
      background: linear-gradient(135deg, var(--accent-3), #4CAF50) !important;
      color: #000 !important;
      font-size: 14px !important;
      font-weight: 700 !important;
      padding: 12px 24px !important;
      border-radius: 8px !important;
      box-shadow: 0 4px 12px rgba(152, 195, 121, 0.3) !important;
      transition: all 0.3s ease !important;
      cursor: pointer;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-width: 200px;
      max-width: 300px;
    }

    .vars-assign-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(152, 195, 121, 0.5) !important;
    }

    .vars-assign-btn:active {
      transform: translateY(0px);
    }

    .btn-subtitle {
      font-size: 10px;
      font-weight: 400;
      opacity: 0.9;
      text-align: center;
    }

    /* Bucket Containers - Side by Side */
    .bucket-container {
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
      background: var(--surface-0);
      display: flex;
      flex-direction: column;
    }

    .bucket-header {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      font-size: 10px;
      font-weight: 700;
      border-bottom: 1px solid var(--border);
      gap: 6px;
    }

    .bucket-header.y-header {
      background: linear-gradient(135deg, rgba(255, 165, 120, 0.2), rgba(255, 165, 120, 0.05));
      color: var(--accent-1);
      border-bottom-color: rgba(255, 165, 120, 0.4);
    }

    .bucket-header.xn-header {
      background: linear-gradient(135deg, rgba(120, 200, 255, 0.2), rgba(120, 200, 255, 0.05));
      color: var(--accent-2);
      border-bottom-color: rgba(120, 200, 255, 0.4);
    }

    .bucket-header.xc-header {
      background: linear-gradient(135deg, rgba(152, 195, 121, 0.2), rgba(152, 195, 121, 0.05));
      color: var(--accent-3);
      border-bottom-color: rgba(152, 195, 121, 0.4);
    }

    .bucket-title-inline {
      flex: 1;
      font-size: 10px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .bucket-title {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Range Options - 3 Panels in Row */
    .range-option {
      flex: 1;
      border: 2px solid var(--border);
      border-radius: 6px;
      background: var(--surface-0);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      position: relative;
      opacity: 0.6;
    }

    .range-option.active {
      border-color: var(--accent-3);
      opacity: 1;
      box-shadow: 0 0 0 2px rgba(152, 195, 121, 0.2);
    }


    .range-option-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: linear-gradient(135deg, rgba(120, 200, 255, 0.15), rgba(120, 200, 255, 0.05));
      border-bottom: 1px solid rgba(120, 200, 255, 0.3);
      transition: background 0.3s ease;
    }

    .range-option.active .range-option-header {
      background: linear-gradient(135deg, rgba(152, 195, 121, 0.25), rgba(152, 195, 121, 0.1));
      border-bottom-color: rgba(152, 195, 121, 0.4);
    }

    .range-option-number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      background: var(--accent-2);
      color: #000;
      border-radius: 50%;
      font-size: 11px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .range-option-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--accent-2);
    }

    .range-option-content {
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
    }

    .bucket-count {
      background: var(--surface-1);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
    }

    .bucket-content {
      padding: 8px;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
    }

    .bucket-content.y-content {
      background: rgba(255, 165, 120, 0.02);
    }

    .bucket-content.xn-content {
      background: rgba(120, 200, 255, 0.02);
    }

    .bucket-content.xc-content {
      background: rgba(152, 195, 121, 0.02);
    }

    .bucket-empty {
      text-align: center;
      color: var(--text-muted);
      font-size: 11px;
      font-style: italic;
      padding: 20px 10px;
      opacity: 0.6;
    }

    .assigned-var-chip {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 6px 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 10px;
      transition: all 0.2s;
      word-break: break-word;
    }

    .assigned-var-chip:hover {
      background: var(--surface-2);
      border-color: var(--accent-3);
    }

    .assigned-var-chip .remove-btn {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      border: none;
      border-radius: 3px;
      padding: 2px 5px;
      cursor: pointer;
      font-size: 10px;
      font-weight: 700;
      transition: all 0.2s;
      margin-left: 8px;
    }

    .assigned-var-chip .remove-btn:hover {
      background: rgba(255, 107, 107, 0.5);
      transform: scale(1.1);
    }

    /* Stats Container (Right Panel) */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-panel {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .stat-panel-heading {
      background: var(--surface-2);
      padding: 10px 12px;
      font-weight: 700;
      font-size: 13px;
      color: var(--accent-1);
      border-bottom: 1px solid var(--border);
    }

    .stat-panel-body {
      padding: 12px;
    }

    .stat-field {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat-field:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .stat-value {
      color: var(--text-primary);
      font-weight: 700;
      font-size: 13px;
    }

    /* Regression Tables (Right Panel) */
    .regression-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .regression-table thead {
      background: var(--surface-2);
    }

    .regression-table th {
      padding: 10px 12px;
      text-align: left;
      font-weight: 700;
      color: var(--accent-1);
      font-size: 11px;
      text-transform: uppercase;
      border-bottom: 2px solid var(--border);
    }

    .regression-table td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .regression-table tbody tr:hover {
      background: rgba(255, 165, 120, 0.05);
    }

    .table-container {
      overflow-x: auto;
    }

    /* Dropdown Menu (Right Panel) */
    .dropdown-container {
      position: relative;
    }

    .dropdown-btn {
      background: var(--surface-2);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dropdown-btn:hover {
      background: var(--surface-1);
    }

    .dropdown-arrow {
      font-size: 10px;
      transition: transform 0.3s;
    }

    .dropdown-container.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .dropdown-content {
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      min-width: 200px;
      display: none;
      z-index: 1000;
    }

    .dropdown-container.open .dropdown-content {
      display: block;
    }

    .dropdown-content a {
      display: block;
      padding: 10px 14px;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 12px;
      transition: background 0.2s;
    }

    .dropdown-content a:hover {
      background: var(--surface-1);
    }

    .dropdown-separator {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
    }

    /* Status Message */
    .status-msg {
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 8px;
      display: none;
    }

    .status-msg.success {
      background: rgba(152, 195, 121, 0.2);
      color: var(--accent-3);
      border: 1px solid rgba(152, 195, 121, 0.3);
      display: block;
    }

    .status-msg.error {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      border: 1px solid rgba(255, 107, 107, 0.3);
      display: block;
    }

    .status-msg.info {
      background: rgba(120, 200, 255, 0.2);
      color: var(--accent-2);
      border: 1px solid rgba(120, 200, 255, 0.3);
      display: block;
    }

    /* Loading Spinner */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      animation: spin 1s linear infinite;
    }

    /* Variable Stats Panel (Click to show) */
    .var-stats-tooltip {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: var(--surface-1);
      border: 2px solid var(--accent-1);
      border-radius: 8px;
      padding: 16px;
      min-width: 280px;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 4000;
      pointer-events: all;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.6);
      font-size: 11px;
      line-height: 1.4;
    }

    .var-stats-tooltip.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .var-stats-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 3999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .var-stats-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    /* Warning Modal for Xc with many categories */
    .warning-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: var(--surface-1);
      border: 2px solid #ffd43b;
      border-radius: 8px;
      padding: 16px;
      min-width: 380px;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      z-index: 2001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.6);
    }

    .warning-modal.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .warning-header {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #ffd43b;
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .warning-icon {
      font-size: 20px;
    }

    .warning-content {
      font-size: 11px;
      line-height: 1.4;
      color: var(--text-secondary);
      margin-bottom: 10px;
      flex-shrink: 0;
    }

    .warning-content p {
      margin: 4px 0;
    }

    .warning-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .warning-btn {
      flex: 1;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .warning-btn.confirm {
      background: linear-gradient(135deg, var(--accent-3), #4CAF50);
      color: #000;
    }

    .warning-btn.confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(152, 195, 121, 0.4);
    }

    .warning-btn.cancel {
      background: var(--surface-2);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .warning-btn.cancel:hover {
      background: var(--surface-0);
    }

    /* Category Selection UI */
    .category-selector-wrapper {
      color: var(--accent-3);
      font-weight: 700;
      margin-top: 10px;
      margin-bottom: 8px;
      font-size: 11px;
      flex-shrink: 0;
    }

    .category-selector {
      max-height: 280px;
      overflow-y: auto;
      overflow-x: hidden;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px;
      background: var(--surface-0);
      margin-bottom: 8px;
      flex: 1;
      min-height: 120px;
    }

    .category-selector::-webkit-scrollbar {
      width: 8px;
    }

    .category-selector::-webkit-scrollbar-track {
      background: var(--surface-1);
      border-radius: 4px;
    }

    .category-selector::-webkit-scrollbar-thumb {
      background: var(--accent-3);
      border-radius: 4px;
    }

    .category-selector::-webkit-scrollbar-thumb:hover {
      background: #4CAF50;
    }

    .category-select-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .category-select-header-text {
      font-size: 10px;
      color: var(--text-muted);
    }

    .select-all-btns {
      display: flex;
      gap: 6px;
    }

    .select-toggle-btn {
      padding: 3px 8px;
      font-size: 9px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 3px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .select-toggle-btn:hover {
      background: var(--surface-1);
      color: var(--accent-3);
    }

    .category-checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 6px;
      border-radius: 3px;
      margin-bottom: 3px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .category-checkbox-row:hover {
      background: var(--surface-1);
    }

    .category-checkbox-row input[type="checkbox"] {
      width: 14px;
      height: 14px;
      cursor: pointer;
      accent-color: var(--accent-3);
      flex-shrink: 0;
    }

    .category-checkbox-label {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      cursor: pointer;
      min-width: 0;
    }

    .category-name {
      color: var(--text-primary);
      font-weight: 500;
      max-width: 60%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .category-stats {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
      font-size: 10px;
      flex-shrink: 0;
    }

    .category-count {
      font-weight: 600;
      color: var(--accent-3);
    }

    .category-bar-mini {
      width: 50px;
      height: 5px;
      background: var(--surface-2);
      border-radius: 3px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .category-bar-fill-mini {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-3), #4CAF50);
      transition: width 0.3s;
    }

    .selection-summary {
      margin-top: 8px;
      padding: 6px;
      background: var(--surface-2);
      border-radius: 4px;
      font-size: 10px;
      color: var(--text-secondary);
      text-align: center;
      flex-shrink: 0;
    }

    .selection-summary.valid {
      color: var(--accent-3);
      font-weight: 600;
    }

    .selection-summary.invalid {
      color: #e06c75;
      font-weight: 600;
    }

    /* Variables Assignment Modal */
    .vars-assign-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: var(--surface-1);
      border: 2px solid var(--accent-3);
      border-radius: 10px;
      width: 90vw;
      max-width: 800px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      z-index: 2001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.7);
    }

    .vars-assign-modal.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .vars-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: linear-gradient(135deg, var(--accent-3), #4CAF50);
      color: #000;
      font-size: 16px;
      font-weight: 700;
      border-radius: 8px 8px 0 0;
      flex-shrink: 0;
    }

    .close-modal-btn {
      background: rgba(0, 0, 0, 0.2);
      border: none;
      color: #000;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 16px;
    }

    .close-modal-btn:hover {
      background: rgba(0, 0, 0, 0.3);
      transform: scale(1.1);
    }

    .vars-modal-info {
      display: flex;
      gap: 20px;
      padding: 12px 20px;
      background: var(--surface-0);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .vars-modal-info-top {
      display: flex;
      gap: 20px;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(152, 195, 121, 0.1), rgba(120, 200, 255, 0.05));
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 16px;
      flex-shrink: 0;
      position: relative;
      z-index: 10;
    }

    .info-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .info-row i {
      font-size: 14px;
      color: var(--accent-3);
    }

    .vars-modal-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px 20px;
      min-height: 300px;
      position: relative;
    }

    .vars-modal-content::-webkit-scrollbar {
      width: 10px;
    }

    .vars-modal-content::-webkit-scrollbar-track {
      background: var(--surface-0);
      border-radius: 5px;
    }

    .vars-modal-content::-webkit-scrollbar-thumb {
      background: var(--accent-3);
      border-radius: 5px;
    }

    .vars-modal-content::-webkit-scrollbar-thumb:hover {
      background: #4CAF50;
    }

    .vars-modal-footer {
      display: flex;
      gap: 10px;
      padding: 16px 20px;
      background: var(--surface-0);
      border-top: 1px solid var(--border);
      border-radius: 0 0 8px 8px;
      flex-shrink: 0;
    }

    .tooltip-title {
      color: var(--accent-1);
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tooltip-close-btn {
      background: rgba(255, 107, 107, 0.2);
      border: 1px solid rgba(255, 107, 107, 0.4);
      color: #ff6b6b;
      border-radius: 4px;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .tooltip-close-btn:hover {
      background: rgba(255, 107, 107, 0.4);
      transform: scale(1.05);
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      color: var(--text-secondary);
    }

    .stat-row .label {
      font-weight: 600;
    }

    .stat-row .value {
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
    }

    .freq-table {
      margin-top: 6px;
      width: 100%;
    }

    .freq-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 6px;
      background: var(--surface-0);
      margin: 2px 0;
      border-radius: 4px;
    }

    .freq-row:nth-child(even) {
      background: var(--surface-1);
    }

    .freq-category {
      font-weight: 600;
      color: var(--accent-2);
      flex: 1;
    }

    .freq-count {
      font-family: 'Courier New', monospace;
      color: var(--text-primary);
      margin: 0 8px;
    }

    .freq-bar {
      flex: 0 0 60px;
      height: 16px;
      background: var(--surface-2);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }

    .freq-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-3), var(--accent-2));
      transition: width 0.3s;
    }

    .variables-table tbody tr {
      position: relative;
    }

    .variables-table tbody tr:hover {
      background: rgba(255, 165, 120, 0.05);
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- LEFT PANEL - INPUT -->
    <div class="left-panel full-width">
      <div class="card-head">
        <span><i class="fa-solid fa-sliders"></i> Multiple Regression (ANCOVA)</span>
        <button class="btn alt" onclick="clearAll()" style="width: auto; padding: 4px 8px; min-height: 28px; font-size: 11px;">
          <i class="fa-solid fa-eraser"></i> Clear All
        </button>
      </div>

      <div class="left-content">
        <!-- Range Selection Panel -->
        <div class="panel-section">
          <div class="section-title">
            <i class="fa-solid fa-database"></i> Pick Data Range
          </div>
          
          <!-- 3 Options in One Row -->
          <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            
            <!-- Option 1: Named Ranges -->
            <div id="rangeOption1" class="range-option">
              <div class="range-option-header">
                <span class="range-option-number">1</span>
                <span class="range-option-title">Named Range</span>
              </div>
              <div class="range-option-content">
                <select id="rangeSelector" onchange="loadFromNamedRange()" style="width: 100%; font-size: 11px; color: var(--text-secondary);">
                  <option value="" style="color: var(--text-muted);">-- Select --</option>
                </select>
              </div>
            </div>
            
            <!-- Option 2: Auto-detect -->
            <div id="rangeOption2" class="range-option">
              <div class="range-option-header">
                <span class="range-option-number">2</span>
                <span class="range-option-title">Auto-detect</span>
              </div>
              <div class="range-option-content">
                <button class="btn alt" onclick="autoDetectRange()" style="width: 100%; padding: 8px; font-size: 11px;">
                  <i class="fa-solid fa-magic"></i> Used Range
                </button>
              </div>
            </div>
            
            <!-- Option 3: Selected Range -->
            <div id="rangeOption3" class="range-option">
              <div class="range-option-header">
                <span class="range-option-number">3</span>
                <span class="range-option-title">Selected Range</span>
              </div>
              <div class="range-option-content">
                <button id="btnUseSelection" class="btn" onclick="useSelection()" style="width: 100%; padding: 8px; font-size: 11px; background: linear-gradient(135deg, var(--accent-2), #4CAF50);" disabled>
                  Select
                </button>
              </div>
            </div>
            
          </div>
          
          <!-- Unified Range Display -->
          <div id="rangeDisplay" style="display: none; background: var(--surface-2); border: 1px solid var(--accent-1); border-radius: 6px; padding: 10px; margin-bottom: 12px; font-size: 11px;">
            <div style="color: var(--accent-1); font-weight: 600; margin-bottom: 6px;">
              <i id="rangeIcon" class="fa-solid fa-bookmark"></i> <span id="rangeTitle"></span>
            </div>
            <div style="color: var(--text-muted); font-size: 10px;">
              <span id="rangeDetails"></span>
            </div>
          </div>
        </div>

        <!-- Variables Assignment Button -->
        <div class="panel-section" style="padding: 0; display: flex; justify-content: center;">
          <button class="btn vars-assign-btn" onclick="openVariablesAssignment()">
            <i class="fa-solid fa-hand-pointer"></i> <strong>Assign Variables to model</strong>
            <div id="varsAssignSummary" class="btn-subtitle">
              Click to assign variables
            </div>
          </button>
        </div>

        <!-- Maximum Usable Cases -->
        <div class="panel-section" style="background: var(--surface-0); border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin-bottom: 12px;">
          <div style="display: flex; align-items: center; gap: 8px; font-size: 11px;">
            <i class="fa-solid fa-database" style="color: var(--accent-2);"></i>
            <span><strong>Maximum Usable Cases:</strong> <span id="maxCases" style="color: var(--accent-2); font-weight: 600;">--</span></span>
          </div>
        </div>

        <!-- Model Assignment Panel (3 Buckets - Always Visible) -->
        <div class="panel-section" style="padding: 0; display: flex; flex-direction: column;">
          <div class="section-title" style="padding: 10px; margin: 0; border-bottom: 1px solid var(--border);">
            <i class="fa-solid fa-chart-line"></i> Model Assignment
          </div>
          
          <!-- All 3 Buckets in One Row -->
          <div style="display: flex; gap: 6px; padding: 10px; align-items: stretch;">
            
            <!-- Y Bucket -->
            <div class="bucket-container" style="flex: 1;">
              <div class="bucket-header y-header">
                <span class="bucket-title-inline">Y (Response)</span>
                <span class="bucket-count" id="countY">0</span>
              </div>
              <div class="bucket-content y-content" id="zoneY">
                <div class="bucket-empty">None</div>
              </div>
            </div>
            
            <!-- Xn Bucket -->
            <div class="bucket-container" style="flex: 1;">
              <div class="bucket-header xn-header">
                <span class="bucket-title-inline">X (numeric)</span>
                <span class="bucket-count" id="countXn">0</span>
              </div>
              <div class="bucket-content xn-content" id="zoneXn">
                <div class="bucket-empty">None</div>
              </div>
            </div>
            
            <!-- Xc Bucket -->
            <div class="bucket-container" style="flex: 1;">
              <div class="bucket-header xc-header">
                <span class="bucket-title-inline">X (Categ.)</span>
                <span class="bucket-count" id="countXc">0</span>
              </div>
              <div class="bucket-content xc-content" id="zoneXc">
                <div class="bucket-empty">None</div>
              </div>
            </div>
            
          </div>
          
          <!-- Actions -->
          <div style="padding: 10px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px;">
            <div style="display: flex; gap: 4px;">
              <label style="display: flex; align-items: center; font-size: 12px; flex: 1;">
                <input type="checkbox" id="interceptCheck" checked style="margin-right: 6px;" />
                + Intercept
              </label>
            </div>

            <button class="btn" onclick="runRegression()">
              <i class="fa-solid fa-play"></i> Run Regression
            </button>

            <div id="leftStatus" class="status-msg"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL - RESULTS -->
    <div class="right-panel hidden">
      <div class="card-head">
        <span><i class="fa-solid fa-chart-line"></i> Linear Regression Analysis</span>
        <div class="dropdown-container">
          <button class="dropdown-btn" id="dropdownBtn">
            Navigation Menu
            <span class="dropdown-arrow">â–¼</span>
          </button>
          <div class="dropdown-content" id="dropdownContent">
            <a href="#" onclick="return false;">Regression Results</a>
            <a href="residual-analysis.html">Residual Analysis</a>
            <a href="diagnostics.html">Diagnostics</a>
            <a href="predictions.html">Predictions</a>
            <div class="dropdown-separator"></div>
            <a href="descriptive-stats.html">Descriptive Statistics</a>
            <a href="correlation-analysis.html">Correlation Analysis</a>
          </div>
        </div>
      </div>

      <div class="right-content">
        <!-- Stats Panels -->
        <div class="stats-container">
          <div class="stat-panel">
            <div class="stat-panel-heading"><i class="fa-solid fa-info-circle"></i> Sample Info</div>
            <div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">Used Obs.:</span>
                <span id="validObs" class="stat-value">--</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Include Intercept?:</span>
                <span id="includeIntercept" class="stat-value">Yes</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Numeric Variables:</span>
                <span id="numNumericVars" class="stat-value">0</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Categorical Variables:</span>
                <span id="numCategoricalVars" class="stat-value">0</span>
              </div>
            </div>
          </div>

          <div class="stat-panel">
            <div class="stat-panel-heading"><i class="fa-solid fa-chart-bar"></i> Model Fit</div>
            <div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">RÂ²:</span>
                <span id="rSquared" class="stat-value">--</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Adjusted RÂ²:</span>
                <span id="adjRSquared" class="stat-value">--</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Root MSE:</span>
                <span id="rootMSE" class="stat-value">--</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">AIC:</span>
                <span id="aic" class="stat-value">--</span>
              </div>
            </div>
          </div>

          <div class="stat-panel">
            <div class="stat-panel-heading"><i class="fa-solid fa-calculator"></i> F-Test</div>
            <div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">F-Statistic:</span>
                <span id="fStatistic" class="stat-value">--</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">P-value:</span>
                <span id="fPValue" class="stat-value">--</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Sum of Squares (Model):</span>
                <span id="ssModel" class="stat-value">--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ANOVA Table -->
        <div class="stat-panel" style="min-width: 100%;">
          <div class="stat-panel-heading"><i class="fa-solid fa-table-cells"></i> Analysis of Variance (ANOVA)</div>
          <div class="stat-panel-body" style="padding: 0;">
            <div class="table-container">
              <table class="regression-table">
                <thead>
                  <tr>
                    <th>Source</th>
                    <th>Sum of Squares</th>
                    <th>df</th>
                    <th>Mean Square</th>
                    <th>F</th>
                    <th>Pr(>F)</th>
                  </tr>
                </thead>
                <tbody id="anovaTableBody">
                  <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">
                      Run regression to see ANOVA table
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Coefficients Table -->
        <div class="stat-panel" style="min-width: 100%;">
          <div class="stat-panel-heading"><i class="fa-solid fa-table"></i> Regression Coefficients</div>
          <div class="stat-panel-body" style="padding: 0;">
            <div class="table-container">
              <table class="regression-table">
                <thead>
                  <tr>
                    <th><i class="fa-solid fa-tag"></i> Variable</th>
                    <th>Estimate</th>
                    <th>Std Error</th>
                    <th>t value</th>
                    <th>Pr(>|t|)</th>
                    <th>CI Lower</th>
                    <th>CI Upper</th>
                  </tr>
                </thead>
                <tbody id="dataTableBody">
                  <tr>
                    <td colspan="7" style="text-align: center; padding: 20px; color: var(--text-muted);">
                      Run regression to see coefficients
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="rightStatus" class="status-msg"></div>
      </div>
    </div>
  </div>

  <!-- Variable Stats Panel (Modal) -->
  <div id="varStatsOverlay" class="var-stats-overlay" onclick="hideVariableStats()"></div>
  <div id="varStatsTooltip" class="var-stats-tooltip"></div>

  <!-- Warning Modal for Xc with many categories -->
  <div id="warningOverlay" class="var-stats-overlay"></div>
  <div id="warningModal" class="warning-modal"></div>

  <!-- Variables Assignment Modal -->
  <div id="varsAssignOverlay" class="var-stats-overlay" onclick="closeVariablesAssignment()"></div>
  <div id="varsAssignModal" class="vars-assign-modal">
    <div class="vars-modal-header">
      <div>
        <i class="fa-solid fa-hand-pointer"></i> <strong>Assign Variables to Model</strong>
      </div>
      <button class="close-modal-btn" onclick="closeVariablesAssignment()" title="Close">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>

    <div class="vars-modal-content">
      <!-- Variable Stats at Top -->
      <div class="vars-modal-info-top">
        <div class="info-row">
          <i class="fa-solid fa-database"></i>
          <span><strong>Variables Loaded:</strong> <span id="modalVarCount">0</span></span>
        </div>
        <div class="info-row">
          <i class="fa-solid fa-check-circle" style="color: var(--accent-3);"></i>
          <span><strong>Assigned:</strong> <span id="modalAssignedCount">0</span></span>
        </div>
        <div class="info-row">
          <i class="fa-solid fa-chart-line" style="color: var(--accent-2);"></i>
          <span><strong>Observations to use:</strong> <span id="modalObsCount" style="color: var(--accent-2); font-weight: 700;">--</span></span>
        </div>
      </div>

      <div class="variables-table-container">
        <table class="variables-table">
          <thead>
            <tr>
              <th style="width: 30px;"></th>
              <th>VARIABLE</th>
              <th class="center" style="width: 50px;" title="Total valid observations">N</th>
              <th class="center" style="width: 50px;" title="Number of numeric observations">nNum</th>
              <th class="center" style="width: 50px;" title="Number of categorical (non-numeric) observations">nCat</th>
              <th class="center" style="width: 150px;">ASSIGN TO</th>
            </tr>
          </thead>
          <tbody id="variablesBody">
            <tr>
              <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">
                No data loaded. Select a range first.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="vars-modal-footer">
      <button class="btn alt" onclick="closeVariablesAssignment()" style="flex: 1;">
        <i class="fa-solid fa-check"></i> Done
      </button>
    </div>
  </div>

  <script>
    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================
    const STATE = {
      variables: [],
      assignments: {
        y: null,
        xn: [],
        xc: []
      },
      currentRange: null,
      rawData: {},
      selectedCategories: {}  // For Xc variables: { varName: [selected categories] }
    };

    // ============================================================================
    // OFFICE.JS INITIALIZATION
    // ============================================================================
    Office.onReady((info) => {
      if (info.host === Office.HostType.Excel) {
        console.log('âœ… Office.js initialized - Pure JavaScript Unified UI ready');
        loadNamedRanges();
        startSelectionMonitor();
      }
    });

    // ============================================================================
    // NAMED RANGES
    // ============================================================================
    function loadNamedRanges() {
      Excel.run(async (context) => {
        const names = context.workbook.names.load('items');
        await context.sync();
        
        const selector = document.getElementById('rangeSelector');
        selector.innerHTML = '<option value="">-- Select Named Range --</option>';
        
        names.items.forEach(name => {
          const option = document.createElement('option');
          option.value = name.name;
          option.textContent = name.name;
          selector.appendChild(option);
        });
        
        console.log(`ðŸ“— Loaded ${names.items.length} named ranges`);
      }).catch(error => {
        console.error('Error loading named ranges:', error);
      });
    }

    // ============================================================================
    // RANGE OPTION SELECTION (MUTUALLY EXCLUSIVE)
    // ============================================================================
    function setActiveRangeOption(optionNumber) {
      // Remove active class from all options
      document.querySelectorAll('.range-option').forEach(opt => opt.classList.remove('active'));
      
      // Add active class to selected option
      const selectedOption = document.getElementById(`rangeOption${optionNumber}`);
      if (selectedOption) {
        selectedOption.classList.add('active');
      }
      
      // Reset named range selector if switching to option 2 or 3
      if (optionNumber !== 1) {
        const rangeSelector = document.getElementById('rangeSelector');
        if (rangeSelector) {
          rangeSelector.value = '';
          rangeSelector.style.color = 'var(--text-muted)'; // Reset to gray
        }
      }
    }

    function loadFromNamedRange() {
      const selector = document.getElementById('rangeSelector');
      const rangeName = selector.value;
      
      // Change color based on selection
      if (!rangeName) {
        selector.style.color = 'var(--text-muted)';
        return;
      }
      
      selector.style.color = 'var(--text-primary)';
      setActiveRangeOption(1); // Mark option 1 as active
      
      Excel.run(async (context) => {
        const namedRange = context.workbook.names.getItem(rangeName);
        const range = namedRange.getRange();
        range.load(['address', 'values', 'rowCount', 'columnCount']);
        await context.sync();
        
        showRangeDisplay(rangeName, range.address, true);
        processRangeData(range.values, range.address);
      }).catch(error => {
        showStatus('error', 'Error loading named range: ' + error.message, 'left');
      });
    }

    // ============================================================================
    // SELECTION MONITORING
    // ============================================================================
    let selectionMonitorInterval = null;

    function startSelectionMonitor() {
      if (selectionMonitorInterval) return;
      
      selectionMonitorInterval = setInterval(() => {
        Excel.run(async (context) => {
          const range = context.workbook.getSelectedRange();
          range.load(['address', 'rowCount', 'columnCount']);
          await context.sync();
          
          const btnUseSelection = document.getElementById('btnUseSelection');
          if (range.rowCount > 1 && range.columnCount > 0) {
            btnUseSelection.disabled = false;
            btnUseSelection.textContent = `âœ“ Use ${range.address}`;
          } else {
            btnUseSelection.disabled = true;
            btnUseSelection.innerHTML = '<i class="fa-solid fa-check"></i> Use Selection';
          }
        }).catch(() => {
          // Silently fail if Excel is not ready
        });
      }, 500);
    }

    function autoDetectRange() {
      setActiveRangeOption(2); // Mark option 2 as active
      
      Excel.run(async (context) => {
        const activeCell = context.workbook.getActiveCell();
        const expandedRange = activeCell.getSurroundingRegion();
        expandedRange.load(['address', 'values', 'rowCount', 'columnCount']);
        await context.sync();
        
        showRangeDisplay('Auto-detected', expandedRange.address, false);
        processRangeData(expandedRange.values, expandedRange.address);
      }).catch(error => {
        showStatus('error', 'Auto-detect failed: ' + error.message, 'left');
      });
    }

    function useSelection() {
      setActiveRangeOption(3); // Mark option 3 as active
      
      Excel.run(async (context) => {
        const range = context.workbook.getSelectedRange();
        range.load(['address', 'values', 'rowCount', 'columnCount']);
        await context.sync();
        
        showRangeDisplay('Manual Selection', range.address, false);
        processRangeData(range.values, range.address);
      }).catch(error => {
        showStatus('error', 'Error using selection: ' + error.message, 'left');
      });
    }

    // ============================================================================
    // RANGE DISPLAY
    // ============================================================================
    function showRangeDisplay(title, address, isNamed) {
      const display = document.getElementById('rangeDisplay');
      const icon = document.getElementById('rangeIcon');
      const titleSpan = document.getElementById('rangeTitle');
      const details = document.getElementById('rangeDetails');
      
      icon.className = isNamed ? 'fa-solid fa-bookmark' : 'fa-solid fa-table-cells';
      titleSpan.textContent = title;
      details.textContent = address;
      display.style.display = 'block';
    }

    // ============================================================================
    // DATA PROCESSING
    // ============================================================================
    function processRangeData(values, address) {
      if (values.length < 2) {
        showStatus('error', 'Range must have at least 2 rows (header + data)', 'left');
        return;
      }
      
      // Extract headers and data
      const headers = values[0];
      const dataRows = values.slice(1);
      
      // Build variables array with enhanced statistics
      STATE.variables = headers.map((header, colIdx) => {
        const columnData = dataRows.map(row => row[colIdx]);
        const validData = columnData.filter(val => val !== null && val !== undefined && val !== '');
        
        // Count numeric vs non-numeric (categorical) observations
        let numericCount = 0;
        let categoricalCount = 0;
        const numericValues = [];
        const categoricalValues = [];
        
        validData.forEach(val => {
          const num = Number(val);
          if (!isNaN(num)) {
            numericCount++;
            numericValues.push(num);
          } else {
            categoricalCount++;
            categoricalValues.push(val);
          }
        });
        
        // Get unique values for reference
        const uniqueValues = [...new Set(validData)];
        
        // Calculate descriptive statistics for numeric data
        let stats = null;
        if (numericValues.length > 0) {
          const sorted = numericValues.slice().sort((a, b) => a - b);
          const sum = numericValues.reduce((acc, val) => acc + val, 0);
          const mean = sum / numericValues.length;
          const variance = numericValues.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / numericValues.length;
          const sd = Math.sqrt(variance);
          
          const q1Index = Math.floor(sorted.length * 0.25);
          const medianIndex = Math.floor(sorted.length * 0.5);
          const q3Index = Math.floor(sorted.length * 0.75);
          
          stats = {
            mean: mean,
            sd: sd,
            min: sorted[0],
            q1: sorted[q1Index],
            median: sorted[medianIndex],
            q3: sorted[q3Index],
            max: sorted[sorted.length - 1]
          };
        }
        
        // Calculate frequency table for categorical data
        let freqTable = null;
        if (categoricalValues.length > 0 || (numericValues.length > 0 && uniqueValues.length <= 20)) {
          // Use all valid data for frequency table if few unique values
          const dataForFreq = uniqueValues.length <= 20 ? validData : categoricalValues;
          const frequencies = {};
          dataForFreq.forEach(val => {
            frequencies[val] = (frequencies[val] || 0) + 1;
          });
          
          // Sort by frequency descending
          freqTable = Object.entries(frequencies)
            .sort((a, b) => b[1] - a[1]); // All categories available
        }
        
        return {
          name: header || `Column${colIdx + 1}`,
          n: validData.length,
          nNum: numericCount,
          nCat: categoricalCount,
          nUnique: uniqueValues.length,
          data: columnData,
          colIdx: colIdx,
          stats: stats,
          freqTable: freqTable
        };
      });
      
      // Store range info
      STATE.currentRange = address;
      
      // Render variables table
      renderVariablesTable();
      updateMaxCases();
      updateVariablesAssignmentInfo();
      showStatus('success', `âœ“ Loaded ${headers.length} variables from ${address}`, 'left');
    }

    function renderVariablesTable() {
      const tbody = document.getElementById('variablesBody');
      tbody.innerHTML = '';
      
      STATE.variables.forEach((variable, idx) => {
        const tr = document.createElement('tr');
        
        // Icon
        const tdIcon = document.createElement('td');
        tdIcon.innerHTML = '<i class="fa-solid fa-database variable-icon"></i>';
        tr.appendChild(tdIcon);
        
        // Name (clickable)
        const tdName = document.createElement('td');
        tdName.textContent = variable.name;
        tdName.style.fontWeight = '600';
        tdName.style.cursor = 'pointer';
        tdName.style.color = 'var(--accent-2)';
        tdName.style.textDecoration = 'underline';
        tdName.title = 'Click to view statistics';
        tdName.onclick = (e) => {
          e.stopPropagation();
          showVariableStats(variable);
        };
        tr.appendChild(tdName);
        
        // N
        const tdN = document.createElement('td');
        tdN.textContent = variable.n;
        tdN.style.textAlign = 'center';
        tdN.style.color = 'var(--text-secondary)';
        tr.appendChild(tdN);
        
        // nNum (numeric observations count)
        const tdNNum = document.createElement('td');
        tdNNum.textContent = variable.nNum;
        tdNNum.style.textAlign = 'center';
        tdNNum.style.fontWeight = '600';
        // Blue if all numeric, gray if mixed or none
        tdNNum.style.color = variable.nNum === variable.n ? 'var(--accent-2)' : 'var(--text-muted)';
        tr.appendChild(tdNNum);
        
        // nCat (categorical/non-numeric observations count)
        const tdNCat = document.createElement('td');
        tdNCat.textContent = variable.nCat;
        tdNCat.style.textAlign = 'center';
        tdNCat.style.fontWeight = '600';
        // Green if has categorical data, gray if pure numeric
        if (variable.nCat > 0 && variable.nUnique <= 10) {
          tdNCat.style.color = 'var(--accent-3)'; // Green - has categorical data with few unique values
        } else if (variable.nCat > 0) {
          tdNCat.style.color = 'var(--accent-1)'; // Orange - has categorical but many unique
        } else {
          tdNCat.style.color = 'var(--text-muted)'; // Gray - no categorical data
        }
        tr.appendChild(tdNCat);
        
        // Assign buttons with tooltips
        const tdAssign = document.createElement('td');
        tdAssign.style.textAlign = 'center';
        
        const btnY = document.createElement('button');
        btnY.className = 'var-assign-btn y';
        btnY.textContent = 'Y';
        btnY.setAttribute('data-tooltip', 'Response Variable (Dependent)');
        btnY.onclick = () => assignVariable(idx, 'y');
        if (STATE.assignments.y === variable.name) btnY.classList.add('active');
        
        const btnXn = document.createElement('button');
        btnXn.className = 'var-assign-btn xn';
        btnXn.textContent = 'Xn';
        btnXn.setAttribute('data-tooltip', 'Numeric Predictor');
        btnXn.onclick = () => assignVariable(idx, 'xn');
        if (STATE.assignments.xn.includes(variable.name)) btnXn.classList.add('active');
        
        const btnXc = document.createElement('button');
        btnXc.className = 'var-assign-btn xc';
        
        // Show category selection info if applicable
        const hasCustomSelection = STATE.selectedCategories[variable.name];
        if (hasCustomSelection) {
          const selectedCount = hasCustomSelection.length;
          const totalCount = variable.nUnique;
          btnXc.textContent = `Xc (${selectedCount}/${totalCount})`;
          btnXc.setAttribute('data-tooltip', `Categorical Predictor - ${selectedCount} of ${totalCount} categories selected. Click to edit.`);
        } else {
          btnXc.textContent = 'Xc';
          btnXc.setAttribute('data-tooltip', 'Categorical Predictor');
        }
        
        btnXc.onclick = () => assignVariable(idx, 'xc');
        if (STATE.assignments.xc.includes(variable.name)) btnXc.classList.add('active');
        
        tdAssign.appendChild(btnY);
        tdAssign.appendChild(document.createTextNode(' '));
        tdAssign.appendChild(btnXn);
        tdAssign.appendChild(document.createTextNode(' '));
        tdAssign.appendChild(btnXc);
        
        tr.appendChild(tdAssign);
        tbody.appendChild(tr);
      });
    }
    
    // ============================================================================
    // VARIABLE STATS PANEL (CLICK TO SHOW)
    // ============================================================================
    function showVariableStats(variable) {
      const tooltip = document.getElementById('varStatsTooltip');
      const overlay = document.getElementById('varStatsOverlay');
      
      let html = `
        <div class="tooltip-title">
          <span><i class="fa-solid fa-chart-bar"></i> ${variable.name}</span>
          <button class="tooltip-close-btn" onclick="hideVariableStats()">
            <i class="fa-solid fa-times"></i> Close
          </button>
        </div>
      `;
      
      // Show numeric statistics if available
      if (variable.stats && variable.nNum > 0) {
        html += `
          <div style="color: var(--accent-2); font-weight: 700; margin-top: 12px; margin-bottom: 6px;">
            ðŸ“Š Numeric Statistics (n=${variable.nNum})
          </div>
          <div class="stat-row"><span class="label">Mean:</span><span class="value">${variable.stats.mean.toFixed(2)}</span></div>
          <div class="stat-row"><span class="label">Std Dev:</span><span class="value">${variable.stats.sd.toFixed(2)}</span></div>
          <div class="stat-row"><span class="label">Min:</span><span class="value">${variable.stats.min.toFixed(2)}</span></div>
          <div class="stat-row"><span class="label">Q1:</span><span class="value">${variable.stats.q1.toFixed(2)}</span></div>
          <div class="stat-row"><span class="label">Median:</span><span class="value">${variable.stats.median.toFixed(2)}</span></div>
          <div class="stat-row"><span class="label">Q3:</span><span class="value">${variable.stats.q3.toFixed(2)}</span></div>
          <div class="stat-row"><span class="label">Max:</span><span class="value">${variable.stats.max.toFixed(2)}</span></div>
        `;
      }
      
      // Show frequency table if available
      if (variable.freqTable && variable.freqTable.length > 0) {
        const totalForPercent = variable.n;
        const maxFreq = Math.max(...variable.freqTable.map(([_, count]) => count));
        
        html += `
          <div style="color: var(--accent-3); font-weight: 700; margin-top: 12px; margin-bottom: 6px;">
            ðŸ“‹ Frequency Table (n=${variable.nCat > 0 ? variable.nCat : variable.n})
          </div>
          <div class="freq-table">
        `;
        
        variable.freqTable.forEach(([category, count]) => {
          const percent = ((count / totalForPercent) * 100).toFixed(1);
          const barWidth = (count / maxFreq * 100);
          html += `
            <div class="freq-row">
              <span class="freq-category">${String(category).substring(0, 25)}</span>
              <span class="freq-count">${count} (${percent}%)</span>
              <div class="freq-bar">
                <div class="freq-bar-fill" style="width: ${barWidth}%"></div>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
      }
      
      // Add summary at bottom
      html += `
        <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid var(--border); color: var(--text-muted); font-size: 10px;">
          Total: ${variable.n} observations | Numeric: ${variable.nNum} | Categorical: ${variable.nCat} | Unique: ${variable.nUnique}
        </div>
      `;
      
      tooltip.innerHTML = html;
      tooltip.classList.add('show');
      overlay.classList.add('show');
    }
    
    function hideVariableStats() {
      const tooltip = document.getElementById('varStatsTooltip');
      const overlay = document.getElementById('varStatsOverlay');
      tooltip.classList.remove('show');
      overlay.classList.remove('show');
    }
    
    // ============================================================================
    // CATEGORY WARNING MODAL
    // ============================================================================
    function showCategoryWarning(variable, varIdx) {
      const modal = document.getElementById('warningModal');
      const overlay = document.getElementById('warningOverlay');
      
      // Get existing selections or default to all categories
      const existingSelections = STATE.selectedCategories[variable.name];
      const allCategories = variable.freqTable ? variable.freqTable.map(([cat, _]) => cat) : variable.uniqueCategories;
      const selectedCats = existingSelections || [...allCategories];
      
      let html = `
        <div class="warning-header">
          <span class="warning-icon">ðŸ“‹</span>
          <span>Select Categories: ${variable.name}</span>
        </div>
        
        <div class="warning-content">
          <p><strong>${variable.nUnique} categories</strong> available. Choose which to include in the model.</p>
        </div>
        
        <div class="category-selector-wrapper">
          <div class="category-select-header">
            <span class="category-select-header-text">Category (Count)</span>
            <div class="select-all-btns">
              <button class="select-toggle-btn" onclick="toggleAllCategories('${variable.name}', true)">All</button>
              <button class="select-toggle-btn" onclick="toggleAllCategories('${variable.name}', false)">None</button>
            </div>
          </div>
        </div>
        
        <div class="category-selector" id="categorySelector">
      `;
      
      // Category selector with checkboxes
      if (variable.freqTable && variable.freqTable.length > 0) {
        const totalForPercent = variable.n;
        const maxFreq = Math.max(...variable.freqTable.map(([_, count]) => count));
        
        variable.freqTable.forEach(([category, count]) => {
          const percent = ((count / totalForPercent) * 100).toFixed(1);
          const barWidth = (count / maxFreq * 100);
          const isChecked = selectedCats.includes(category);
          const catId = `cat_${variable.name}_${String(category).replace(/[^a-zA-Z0-9]/g, '_')}`;
          
          html += `
            <div class="category-checkbox-row" onclick="toggleCategoryCheckbox('${catId}')">
              <input type="checkbox" 
                     id="${catId}" 
                     data-category="${String(category)}" 
                     data-varname="${variable.name}"
                     ${isChecked ? 'checked' : ''}
                     onchange="updateCategorySelectionSummary('${variable.name}')"
                     onclick="event.stopPropagation()">
              <label class="category-checkbox-label" for="${catId}">
                <span class="category-name" title="${String(category)}">${String(category).substring(0, 25)}</span>
                <div class="category-stats">
                  <span class="category-count">${count}</span>
                  <span>(${percent}%)</span>
                  <div class="category-bar-mini">
                    <div class="category-bar-fill-mini" style="width: ${barWidth}%"></div>
                  </div>
                </div>
              </label>
            </div>
          `;
        });
      }
      
      html += '</div>'; // Close category-selector
      
      html += `
        <div class="selection-summary" id="selectionSummary">
          <span id="summaryText">Select at least 2 categories</span>
        </div>
        
        <div class="warning-actions">
          <button class="warning-btn cancel" onclick="closeCategoryWarning()">
            <i class="fa-solid fa-times"></i> Cancel
          </button>
          <button class="warning-btn confirm" id="confirmBtn" onclick="confirmCategoryAssignment(${varIdx})">
            <i class="fa-solid fa-check"></i> Confirm
          </button>
        </div>
      `;
      
      modal.innerHTML = html;
      modal.classList.add('show');
      overlay.classList.add('show');
      
      // Update summary after render
      updateCategorySelectionSummary(variable.name);
    }
    
    function closeCategoryWarning() {
      const modal = document.getElementById('warningModal');
      const overlay = document.getElementById('warningOverlay');
      modal.classList.remove('show');
      overlay.classList.remove('show');
    }
    
    // ============================================================================
    // VARIABLES ASSIGNMENT MODAL
    // ============================================================================
    function openVariablesAssignment() {
      const modal = document.getElementById('varsAssignModal');
      const overlay = document.getElementById('varsAssignOverlay');
      
      // Update counts before showing
      updateVariablesAssignmentInfo();
      
      modal.classList.add('show');
      overlay.classList.add('show');
    }
    
    function closeVariablesAssignment() {
      const modal = document.getElementById('varsAssignModal');
      const overlay = document.getElementById('varsAssignOverlay');
      modal.classList.remove('show');
      overlay.classList.remove('show');
    }
    
    function updateVariablesAssignmentInfo() {
      // Update modal counts
      const varCount = STATE.variables.length;
      const assignedCount = (STATE.assignments.y ? 1 : 0) + 
                            STATE.assignments.xn.length + 
                            STATE.assignments.xc.length;
      
      document.getElementById('modalVarCount').textContent = varCount;
      document.getElementById('modalAssignedCount').textContent = assignedCount;
      
      // Calculate observations that will be used
      const obsCount = calculateUsableObservations();
      document.getElementById('modalObsCount').textContent = obsCount;
      
      // Update button summary
      const btnSummary = document.getElementById('varsAssignSummary');
      if (varCount === 0) {
        btnSummary.textContent = 'Click to assign variables';
      } else if (assignedCount === 0) {
        btnSummary.textContent = `${varCount} vars loaded - none assigned`;
      } else {
        btnSummary.textContent = `${assignedCount}/${varCount} assigned â€¢ ${obsCount} obs`;
      }
    }
    
    function calculateUsableObservations() {
      if (!STATE.assignments.y && STATE.assignments.xn.length === 0 && STATE.assignments.xc.length === 0) {
        return '--';
      }
      
      // Get all assigned variables
      const assignedVars = [];
      if (STATE.assignments.y) assignedVars.push(STATE.assignments.y);
      assignedVars.push(...STATE.assignments.xn);
      assignedVars.push(...STATE.assignments.xc);
      
      if (assignedVars.length === 0) return '--';
      
      // Find corresponding variable objects
      const varObjects = assignedVars.map(name => 
        STATE.variables.find(v => v.name === name)
      ).filter(v => v);
      
      if (varObjects.length === 0) return '--';
      
      // Count observations where ALL assigned variables have valid data
      const maxRows = Math.max(...varObjects.map(v => v.data.length));
      let validCount = 0;
      
      for (let i = 0; i < maxRows; i++) {
        const allValid = varObjects.every(v => {
          if (i >= v.data.length) return false;
          const val = v.data[i];
          return val !== null && val !== undefined && val !== '';
        });
        if (allValid) validCount++;
      }
      
      return validCount;
    }
    
    function toggleCategoryCheckbox(checkboxId) {
      const checkbox = document.getElementById(checkboxId);
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        updateCategorySelectionSummary(checkbox.dataset.varname);
      }
    }
    
    function toggleAllCategories(varName, selectAll) {
      const checkboxes = document.querySelectorAll(`input[type="checkbox"][data-varname="${varName}"]`);
      checkboxes.forEach(cb => cb.checked = selectAll);
      updateCategorySelectionSummary(varName);
    }
    
    function updateCategorySelectionSummary(varName) {
      const checkboxes = document.querySelectorAll(`input[type="checkbox"][data-varname="${varName}"]`);
      const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const totalCount = checkboxes.length;
      
      const summaryText = document.getElementById('summaryText');
      const summary = document.getElementById('selectionSummary');
      const confirmBtn = document.getElementById('confirmBtn');
      
      if (!summaryText || !summary || !confirmBtn) return;
      
      if (selectedCount < 2) {
        summaryText.textContent = `âš ï¸ Select at least 2 categories (currently ${selectedCount} selected)`;
        summary.className = 'selection-summary invalid';
        confirmBtn.disabled = true;
        confirmBtn.style.opacity = '0.5';
        confirmBtn.style.cursor = 'not-allowed';
      } else {
        const dummyCount = selectedCount - 1;
        summaryText.textContent = `âœ“ ${selectedCount} of ${totalCount} categories selected â†’ ${dummyCount} dummy variable${dummyCount !== 1 ? 's' : ''}`;
        summary.className = 'selection-summary valid';
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
        confirmBtn.style.cursor = 'pointer';
      }
    }
    
    function confirmCategoryAssignment(varIdx) {
      const variable = STATE.variables[varIdx];
      
      // Get selected categories
      const checkboxes = document.querySelectorAll(`input[type="checkbox"][data-varname="${variable.name}"]`);
      const selectedCategories = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.dataset.category);
      
      if (selectedCategories.length < 2) {
        alert('Please select at least 2 categories to create a categorical variable.');
        return;
      }
      
      // Store selected categories
      STATE.selectedCategories[variable.name] = selectedCategories;
      console.log(`ðŸ“‹ Selected categories for ${variable.name}:`, selectedCategories);
      
      closeCategoryWarning();
      performAssignment(variable.name, 'xc', false);
    }

    // ============================================================================
    // VARIABLE ASSIGNMENT (MUTUALLY EXCLUSIVE)
    // ============================================================================
    function assignVariable(varIdx, bucket) {
      const variable = STATE.variables[varIdx];
      
      // Check if already assigned to THIS specific bucket (for toggle behavior)
      let isAlreadyInThisBucket = false;
      if (bucket === 'y') {
        isAlreadyInThisBucket = STATE.assignments.y === variable.name;
      } else if (bucket === 'xn') {
        isAlreadyInThisBucket = STATE.assignments.xn.includes(variable.name);
      } else if (bucket === 'xc') {
        isAlreadyInThisBucket = STATE.assignments.xc.includes(variable.name);
      }
      
      // Category selector for ALL Xc assignments (always show selector)
      if (bucket === 'xc') {
        showCategoryWarning(variable, varIdx);
        return; // Don't assign yet, wait for user confirmation
      }
      
      // Proceed with assignment
      performAssignment(variable.name, bucket, isAlreadyInThisBucket);
    }
    
    function performAssignment(varName, bucket, wasInBucket) {
      // Remove from all buckets first (ensures mutual exclusivity)
      removeVariableFromAllAssignments(varName);
      
      // If it WASN'T in this bucket, add it (if it WAS, leave it removed - toggle off)
      if (!wasInBucket) {
        if (bucket === 'y') {
          STATE.assignments.y = varName;
        } else if (bucket === 'xn') {
          STATE.assignments.xn.push(varName);
        } else if (bucket === 'xc') {
          STATE.assignments.xc.push(varName);
        }
      }
      
      renderVariablesTable();
      updateBucketDisplay();
      updateMaxCases();
      updateVariablesAssignmentInfo(); // Update modal info in real-time
    }
    
    function removeVariableFromAllAssignments(varName) {
      // Remove from Y
      if (STATE.assignments.y === varName) {
        STATE.assignments.y = null;
      }
      
      // Remove from Xn
      const xnIdx = STATE.assignments.xn.indexOf(varName);
      if (xnIdx >= 0) {
        STATE.assignments.xn.splice(xnIdx, 1);
      }
      
      // Remove from Xc
      const xcIdx = STATE.assignments.xc.indexOf(varName);
      if (xcIdx >= 0) {
        STATE.assignments.xc.splice(xcIdx, 1);
      }
    }

    function updateBucketDisplay() {
      // Update counts
      document.getElementById('countY').textContent = STATE.assignments.y ? 1 : 0;
      document.getElementById('countXn').textContent = STATE.assignments.xn.length;
      document.getElementById('countXc').textContent = STATE.assignments.xc.length;
      
      // Update bucket contents
      updateBucketContent('zoneY', STATE.assignments.y ? [STATE.assignments.y] : [], 'y');
      updateBucketContent('zoneXn', STATE.assignments.xn, 'xn');
      updateBucketContent('zoneXc', STATE.assignments.xc, 'xc');
    }

    function updateBucketContent(zoneId, variables, bucket) {
      const zone = document.getElementById(zoneId);
      zone.innerHTML = '';
      
      if (variables.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'bucket-empty';
        empty.textContent = 'None';
        zone.appendChild(empty);
      } else {
        variables.forEach(varName => {
          const chip = document.createElement('div');
          chip.className = 'assigned-var-chip';
          
          // Check if this variable has custom category selection
          const variable = STATE.variables.find(v => v.name === varName);
          const hasCustomSelection = STATE.selectedCategories[varName];
          let displayName = varName;
          
          if (hasCustomSelection && variable) {
            const selectedCount = hasCustomSelection.length;
            const totalCount = variable.nUnique;
            displayName = `${varName} (${selectedCount}/${totalCount} cats)`;
          }
          
          chip.innerHTML = `
            <span style="font-weight: 600;">${displayName}</span>
            <button class="remove-btn" onclick="removeAssignment('${varName}', '${bucket}')" title="Remove">âœ•</button>
          `;
          zone.appendChild(chip);
        });
      }
    }

    function removeAssignment(varName, bucket) {
      // Simply remove from all assignments (already exclusive)
      removeVariableFromAllAssignments(varName);
      
      renderVariablesTable();
      updateBucketDisplay();
      updateMaxCases();
    }

    // switchBucketTab removed - all buckets now always visible
    
    // ============================================================================
    // MAX CASES
    // ============================================================================
    function updateMaxCases() {
      if (!STATE.assignments.y) {
        document.getElementById('maxCases').textContent = '--';
        return;
      }
      
      const assignedVars = [STATE.assignments.y, ...STATE.assignments.xn, ...STATE.assignments.xc];
      const varsData = STATE.variables.filter(v => assignedVars.includes(v.name));
      
      // Count rows with no missing values
      const numRows = varsData[0].data.length;
      let validCount = 0;
      
      for (let i = 0; i < numRows; i++) {
        const allValid = varsData.every(v => {
          const val = v.data[i];
          return val !== null && val !== undefined && val !== '';
        });
        if (allValid) validCount++;
      }
      
      document.getElementById('maxCases').textContent = validCount;
    }

    // ============================================================================
    // RUN REGRESSION (Using working JS from OLD folder)
    // ============================================================================
    async function runRegression() {
      // Validate
      if (!STATE.assignments.y) {
        showStatus('error', 'Please assign a Y variable', 'left');
        return;
      }
      
      if (STATE.assignments.xn.length === 0 && STATE.assignments.xc.length === 0) {
        showStatus('error', 'Please assign at least one X variable', 'left');
        return;
      }
      
      showStatus('info', '<i class="fa-solid fa-spinner spinner"></i> Running regression...', 'left');
      
      try {
        // Prepare data in the correct format (X as ROWS, not columns)
        const includeIntercept = document.getElementById('interceptCheck').checked;
        const yVar = STATE.variables.find(v => v.name === STATE.assignments.y);
        
        // Collect numeric variables
        const xNumericVars = [];
        const xNumericNames = [];
        STATE.assignments.xn.forEach(varName => {
          const v = STATE.variables.find(v => v.name === varName);
          if (v) {
            xNumericVars.push(v);
            xNumericNames.push(varName);
          }
        });
        
        // Process categorical variables with dummy coding
        const xCategoricalVars = [];
        const xCategoricalNames = [];
        const dummyInfo = {}; // Track dummy variable information
        
        STATE.assignments.xc.forEach(varName => {
          const v = STATE.variables.find(v => v.name === varName);
          if (v) {
            // Get all unique categories (excluding null/empty)
            let allCategories = [...new Set(v.data.filter(val => 
              val !== null && val !== undefined && val !== ''
            ))].sort();
            
            // Use selected categories if available, otherwise use all
            let categories = STATE.selectedCategories[varName] 
              ? STATE.selectedCategories[varName].filter(cat => allCategories.includes(cat))
              : allCategories;
            
            // If no selection stored yet but >5 categories, this shouldn't happen (modal should show first)
            // But as a safeguard, use all categories
            if (categories.length === 0) {
              categories = allCategories;
            }
            
            console.log(`ðŸ“Š Categorical variable "${varName}" - Using ${categories.length} of ${allCategories.length} categories:`, categories);
            
            if (categories.length < 2) {
              throw new Error(`Categorical variable "${varName}" needs at least 2 categories. Currently selected: ${categories.length}`);
            }
            
            // Create k-1 dummy variables (first category is reference)
            const referenceCategory = categories[0];
            dummyInfo[varName] = {
              reference: referenceCategory,
              categories: categories,
              totalCategories: allCategories.length,
              excluded: allCategories.filter(cat => !categories.includes(cat))
            };
            
            for (let i = 1; i < categories.length; i++) {
              const category = categories[i];
              const dummyVar = {
                name: `${varName}_${category}`,
                originalVar: varName,
                category: category,
                data: v.data.map(val => (val === category ? 1 : 0))
              };
              xCategoricalVars.push(dummyVar);
              xCategoricalNames.push(`${varName}=${category}`);
            }
            
            console.log(`   âœ“ Created ${categories.length - 1} dummy variables (reference: ${referenceCategory})`);
            if (dummyInfo[varName].excluded.length > 0) {
              console.log(`   ðŸ“Œ Excluded categories: ${dummyInfo[varName].excluded.join(', ')}`);
            }
          }
        });
        
        // Combine all X variables (numeric + dummy-coded categorical)
        const allXVars = [...xNumericVars, ...xCategoricalVars];
        const allXNames = [...xNumericNames, ...xCategoricalNames];
        
        // Convert to numeric and build X matrix (each ROW is an observation)
        const Y = [];
        const X = [];
        
        const numObs = yVar.data.length;
        for (let i = 0; i < numObs; i++) {
          const yVal = Number(yVar.data[i]);
          const xRow = allXVars.map(xVar => Number(xVar.data[i]));
          
          // Check for missing values
          const allValid = !isNaN(yVal) && xRow.every(x => !isNaN(x));
          
          if (allValid) {
            Y.push(yVal);
            X.push(xRow);
          }
        }
        
        console.log(`ðŸ“Š Data prepared: ${Y.length} observations, ${X[0].length} predictors`);
        console.log(`   Numeric variables: ${xNumericNames.length}`);
        console.log(`   Categorical variables: ${STATE.assignments.xc.length} (${xCategoricalVars.length} dummies)`);
        console.log(`   Y: ${Y.length} values`);
        console.log(`   X: ${X.length} rows Ã— ${X[0].length} cols`);
        
        // Check for perfect multicollinearity before running regression
        if (X[0].length >= Y.length) {
          throw new Error(`Too many predictors (${X[0].length}) for ${Y.length} observations. Need at least ${X[0].length + 1} observations.`);
        }
        
        // Run regression using working computeOLS function
        const results = computeOLS(X, Y, includeIntercept, 0.05);
        
        // Add variable names and dummy info
        results.yVarName = STATE.assignments.y;
        results.xVarNames = allXNames;
        results.numericVarCount = xNumericNames.length;
        results.categoricalVarCount = STATE.assignments.xc.length;
        results.dummyInfo = dummyInfo;
        
        // Format results for popup and store in localStorage
        formatAndOpenPopup(results);
        
        showStatus('success', `âœ“ Regression complete! RÂ² = ${results.R2.toFixed(4)} - Opening results popup...`, 'left');
        
      } catch (error) {
        console.error('Regression failed:', error);
        showStatus('error', 'âœ— Regression failed: ' + error.message, 'left');
      }
    }
    
    // ============================================================================
    // REGRESSION COMPUTATION (Working version from OLD folder)
    // ============================================================================
    function computeOLS(X, Y, includeIntercept, alpha) {
      const n = Y.length;
      const p = X[0].length;
      
      // Add intercept column if requested
      if (includeIntercept) {
        X = X.map(row => [1, ...row]);
      }
      
      const k = X[0].length; // Number of parameters (including intercept if any)
      
      // Compute X'X
      const XtX = matrixMultiply(transpose(X), X);
      
      // Compute (X'X)^-1
      const XtX_inv = matrixInverse(XtX);
      
      // Compute coefficients: Î² = (X'X)^-1 X'Y
      const Xt = transpose(X);
      const XtY = matrixMultiply(Xt, Y.map(y => [y]));
      const beta = matrixMultiply(XtX_inv, XtY).map(row => row[0]);
      
      // Compute fitted values and residuals
      const Y_fit = X.map(row => row.reduce((sum, xi, i) => sum + xi * beta[i], 0));
      const residuals = Y.map((yi, i) => yi - Y_fit[i]);
      
      // Compute sum of squares
      const Y_mean = Y.reduce((sum, y) => sum + y, 0) / n;
      const TSS = Y.reduce((sum, y) => sum + Math.pow(y - Y_mean, 2), 0);
      const SSR = residuals.reduce((sum, r) => sum + r * r, 0);
      const SSE = TSS - SSR;
      
      // RÂ² and Adjusted RÂ²
      const R2 = 1 - (SSR / TSS);
      const R2_adj = 1 - ((1 - R2) * (n - 1) / (n - k));
      
      // Standard error of regression
      const MSE = SSR / (n - k);
      const RMSE = Math.sqrt(MSE);
      
      // Standard errors of coefficients
      const SE = beta.map((_, i) => Math.sqrt(XtX_inv[i][i] * MSE));
      
      // t-values
      const t_values = beta.map((b, i) => b / SE[i]);
      
      // p-values (two-tailed t-test)
      const df = n - k;
      const p_values = t_values.map(t => 2 * (1 - tCDF(Math.abs(t), df)));
      
      // Confidence intervals
      const t_crit = tInverse(alpha / 2, df);
      const CI_lower = beta.map((b, i) => b - t_crit * SE[i]);
      const CI_upper = beta.map((b, i) => b + t_crit * SE[i]);
      
      // F-statistic
      const F_stat = (SSE / (k - 1)) / (SSR / (n - k));
      const F_pvalue = 1 - fCDF(F_stat, k - 1, n - k);
      
      // AIC and BIC
      const AIC = n * Math.log(SSR / n) + 2 * k;
      const BIC = n * Math.log(SSR / n) + k * Math.log(n);
      
      return {
        coefficients: beta,
        std_errors: SE,
        t_values: t_values,
        p_values: p_values,
        CI_lower: CI_lower,
        CI_upper: CI_upper,
        R2: R2,
        R2_adj: R2_adj,
        RMSE: RMSE,
        MSE: MSE,
        F_stat: F_stat,
        F_pvalue: F_pvalue,
        AIC: AIC,
        BIC: BIC,
        TSS: TSS,
        SSR: SSR,
        SSE: SSE,
        n: n,
        k: k,
        p: p,
        df: df,
        includeIntercept: includeIntercept,
        alpha: alpha,
        residuals: residuals,
        Y_fit: Y_fit
      };
    }
    
    // ============================================================================
    // MATRIX OPERATIONS (Working versions from OLD folder)
    // ============================================================================
    function transpose(matrix) {
      return matrix[0].map((_, colIndex) => matrix.map(row => row[colIndex]));
    }
    
    function matrixMultiply(A, B) {
      const result = [];
      for (let i = 0; i < A.length; i++) {
        result[i] = [];
        for (let j = 0; j < B[0].length; j++) {
          let sum = 0;
          for (let k = 0; k < A[0].length; k++) {
            sum += A[i][k] * B[k][j];
          }
          result[i][j] = sum;
        }
      }
      return result;
    }
    
    function matrixInverse(matrix) {
      const n = matrix.length;
      const augmented = matrix.map((row, i) => [
        ...row,
        ...Array(n).fill(0).map((_, j) => i === j ? 1 : 0)
      ]);
      
      // Gauss-Jordan elimination
      for (let i = 0; i < n; i++) {
        // Find pivot
        let maxRow = i;
        for (let k = i + 1; k < n; k++) {
          if (Math.abs(augmented[k][i]) > Math.abs(augmented[maxRow][i])) {
            maxRow = k;
          }
        }
        [augmented[i], augmented[maxRow]] = [augmented[maxRow], augmented[i]];
        
        // Make diagonal 1
        const divisor = augmented[i][i];
        if (Math.abs(divisor) < 1e-10) {
          throw new Error('Matrix is singular or near-singular - check for multicollinearity');
        }
        for (let j = 0; j < 2 * n; j++) {
          augmented[i][j] /= divisor;
        }
        
        // Eliminate column
        for (let k = 0; k < n; k++) {
          if (k !== i) {
            const factor = augmented[k][i];
            for (let j = 0; j < 2 * n; j++) {
              augmented[k][j] -= factor * augmented[i][j];
            }
          }
        }
      }
      
      // Extract inverse
      return augmented.map(row => row.slice(n));
    }
    
    // ============================================================================
    // STATISTICAL DISTRIBUTION FUNCTIONS
    // ============================================================================
    function tCDF(t, df) {
      // Approximation of Student's t CDF
      const x = df / (df + t * t);
      return 1 - 0.5 * incompleteBeta(df / 2, 0.5, x);
    }
    
    function tInverse(p, df) {
      // Approximation of t critical value
      return Math.sqrt(df * (Math.pow(1 - 2 * p, -2 / df) - 1));
    }
    
    function fCDF(f, df1, df2) {
      // Approximation of F CDF
      const x = df2 / (df2 + df1 * f);
      return 1 - incompleteBeta(df2 / 2, df1 / 2, x);
    }
    
    function incompleteBeta(a, b, x) {
      // Simple approximation
      if (x <= 0) return 0;
      if (x >= 1) return 1;
      return Math.pow(x, a) * Math.pow(1 - x, b) / (a + b);
    }

    // ============================================================================
    // FORMAT AND OPEN POPUP (Replaces right panel display)
    // ============================================================================
    function formatAndOpenPopup(results) {
      console.log('ðŸ“Š Formatting results for popup...');
      
      // Calculate ANOVA components
      const dfModel = results.k - 1;
      const dfResidual = results.df;
      const dfTotal = results.n - 1;
      const msModel = results.SSE / dfModel;
      const msResidual = results.MSE;
      
      // Format results data for popup
      const resultsData = {
        sampleInfo: {
          usedObs: results.n,
          includeIntercept: results.includeIntercept ? 'Yes' : 'No',
          numericVars: results.numericVarCount || 0,
          categoricalVars: results.categoricalVarCount || 0
        },
        modelFit: {
          rSquared: results.R2.toFixed(4),
          adjRSquared: results.R2_adj.toFixed(4),
          rootMSE: results.RMSE.toFixed(4),
          aic: results.AIC.toFixed(2)
        },
        fTest: {
          fStatistic: results.F_stat.toFixed(4),
          pValue: results.F_pvalue < 0.0001 ? '<0.0001' : results.F_pvalue.toFixed(4),
          ssModel: results.SSE.toFixed(2)
        },
        anovaTable: {
          model: {
            ss: results.SSE.toFixed(4),
            df: dfModel,
            ms: msModel.toFixed(4),
            f: results.F_stat.toFixed(4),
            pValue: results.F_pvalue < 0.0001 ? '<0.0001' : results.F_pvalue.toFixed(4)
          },
          residual: {
            ss: results.SSR.toFixed(4),
            df: dfResidual,
            ms: msResidual.toFixed(4)
          },
          total: {
            ss: results.TSS.toFixed(4),
            df: dfTotal
          }
        },
        coefficients: []
      };
      
      // Format coefficients
      for (let i = 0; i < results.coefficients.length; i++) {
        let varName;
        if (results.includeIntercept) {
          varName = i === 0 ? 'Intercept' : results.xVarNames[i - 1];
        } else {
          varName = results.xVarNames[i];
        }
        
        resultsData.coefficients.push({
          variable: varName,
          estimate: results.coefficients[i].toFixed(4),
          stdError: results.std_errors[i].toFixed(4),
          tValue: results.t_values[i].toFixed(4),
          pValue: results.p_values[i] < 0.0001 ? '<0.0001' : results.p_values[i].toFixed(4),
          ciLower: results.CI_lower[i].toFixed(4),
          ciUpper: results.CI_upper[i].toFixed(4)
        });
      }
      
      // Store in localStorage for popup to access
      localStorage.setItem('regressionResults', JSON.stringify(resultsData));
      console.log('ðŸ’¾ Results stored in localStorage');
      
      // Open popup dialog
      openResultsPopup();
    }
    
    function openResultsPopup() {
      // Get the dialog URL (same origin)
      const dialogUrl = location.origin + location.pathname.replace(/[^/]*$/, '') + 'regression-results-popup.html';
      
      console.log('ðŸŒ Opening results popup...');
      console.log('ðŸ“ Dialog URL:', dialogUrl);
      
      // Check if Office.context.ui is available
      if (!Office.context.ui) {
        console.error('âŒ Office.context.ui is not available!');
        showStatus('error', 'âŒ Dialog API not available - results stored in console', 'left');
        return;
      }
      
      console.log('âœ… Office.context.ui available, calling displayDialogAsync...');
      
      Office.context.ui.displayDialogAsync(
        dialogUrl,
        { height: 80, width: 90, displayInIframe: false },
        function(result) {
          if (result.status === Office.AsyncResultStatus.Failed) {
            console.error('âŒ Failed to open results dialog');
            console.error('âŒ Error:', result.error.message);
            showStatus('error', 'âŒ Could not open results window: ' + result.error.message, 'left');
          } else {
            console.log('âœ… Results dialog opened successfully!');
            window.regressionDialog = result.value;
            showStatus('success', 'âœ… Results window opened!', 'left');
          }
        }
      );
    }

    // ============================================================================
    // UI CONTROLS
    // ============================================================================
    function clearAll() {
      if (!confirm('Clear all data and assignments?')) return;
      
      STATE.variables = [];
      STATE.assignments = { y: null, xn: [], xc: [] };
      STATE.currentRange = null;
      STATE.rawData = {};
      STATE.selectedCategories = {};
      
      document.getElementById('variablesBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">No data loaded. Select a range above.</td></tr>';
      document.getElementById('rangeDisplay').style.display = 'none';
      document.getElementById('rangeSelector').value = '';
      document.getElementById('maxCases').textContent = '--';
      
      updateBucketDisplay();
      updateVariablesAssignmentInfo();
      showStatus('info', 'All data cleared', 'left');
    }

    // Dropdown toggle
    document.getElementById('dropdownBtn').addEventListener('click', function() {
      document.querySelector('.dropdown-container').classList.toggle('open');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const dropdown = document.querySelector('.dropdown-container');
      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
      }
    });

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    function formatNumber(value, decimals = 4) {
      if (value === null || value === undefined || isNaN(value)) {
        return '---';
      }
      if (Math.abs(value) < 0.0001 && value !== 0) {
        return value.toExponential(2);
      }
      return value.toFixed(decimals);
    }

    function formatPValue(pValue) {
      if (pValue === null || pValue === undefined || isNaN(pValue)) {
        return '---';
      }
      if (pValue < 0.001) {
        return '< 0.001';
      }
      return pValue.toFixed(4);
    }

    function getSignificanceStars(pValue) {
      if (pValue < 0.001) return '***';
      if (pValue < 0.01) return '**';
      if (pValue < 0.05) return '*';
      if (pValue < 0.1) return '.';
      return '';
    }

    function showStatus(type, message, panel) {
      const statusId = panel === 'left' ? 'leftStatus' : 'rightStatus';
      const status = document.getElementById(statusId);
      status.className = `status-msg ${type}`;
      status.innerHTML = message;
      
      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          status.style.display = 'none';
        }, 5000);
      }
    }

    console.log('âœ… Pure JavaScript Unified Regression - Ready');
  </script>
</body>
</html>
