<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multiple Regression (ANCOVA)</title>
  
  <!-- Office.js -->
  <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      text-align: center;
      background: #0c1624;
      color: #fff;
      margin: 0;
    }
    .launcher {
      max-width: 400px;
      margin: 50px auto;
      padding: 30px;
      background: #1a1f2e;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    h2 {
      color: rgb(255,165,120);
      margin-top: 0;
    }
    .status {
      margin: 20px 0;
      padding: 15px;
      background: #242938;
      border-radius: 6px;
      font-size: 13px;
    }
    .loading {
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    button {
      background: linear-gradient(135deg, rgb(255,165,120), #e67e22);
      border: 0;
      border-radius: 6px;
      color: #0c1624;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      margin: 10px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255,165,120,0.3);
    }
  </style>
</head>
<body>
  <div class="launcher">
    <h2>üìä Multiple Regression</h2>
    <div class="status loading" id="status">
      Opening popup window...
    </div>
    <button onclick="openPopup()" id="retryBtn" style="display:none;">
      üîÑ Retry
    </button>
    <button onclick="loadDirectly()" id="directBtn" style="display:none;">
      üìä Open Here Instead
    </button>
  </div>

  <script>
    let dialog = null;
    let isInDialog = false;

    Office.onReady(() => {
      console.log('Office.js ready');
      
      // Check if we're already in a dialog
      try {
        if (window.opener || window.location.search.includes('_host_Info=')) {
          isInDialog = true;
          console.log('Already in dialog, loading main UI');
          loadMainUI();
          return;
        }
      } catch (e) {
        console.log('Dialog check error:', e);
      }

      // Not in dialog, so open one
      setTimeout(() => openPopup(), 500);
    });

    function openPopup() {
      const status = document.getElementById('status');
      const retryBtn = document.getElementById('retryBtn');
      const directBtn = document.getElementById('directBtn');

      status.textContent = 'Opening popup window...';
      status.className = 'status loading';
      retryBtn.style.display = 'none';
      directBtn.style.display = 'none';

      const baseUrl = window.location.href.split('?')[0].split('#')[0];
      const dialogUrl = baseUrl.replace('regression-popup-auto.html', 'regression-unified.html');

      Office.context.ui.displayDialogAsync(
        dialogUrl,
        {
          height: 90,
          width: 90,
          displayInIframe: false
        },
        function (asyncResult) {
          if (asyncResult.status === Office.AsyncResultStatus.Failed) {
            console.error('Dialog failed:', asyncResult.error);
            status.textContent = '‚ùå Could not open popup: ' + asyncResult.error.message;
            status.className = 'status';
            retryBtn.style.display = 'inline-block';
            directBtn.style.display = 'inline-block';
          } else {
            console.log('Dialog opened successfully');
            dialog = asyncResult.value;
            status.textContent = '‚úÖ Popup window opened!';
            status.className = 'status';
            
            // Handle messages from dialog
            dialog.addEventHandler(Office.EventType.DialogMessageReceived, function(arg) {
              console.log('Message from dialog:', arg.message);
            });
            
            // Handle dialog close
            dialog.addEventHandler(Office.EventType.DialogEventReceived, function(arg) {
              console.log('Dialog closed');
              status.textContent = 'Dialog closed. Click below to reopen.';
              retryBtn.style.display = 'inline-block';
            });
          }
        }
      );
    }

    function loadDirectly() {
      // Load the main UI directly in this window
      window.location.href = window.location.href.replace('regression-popup-auto.html', 'regression-unified.html');
    }

    function loadMainUI() {
      // If we're in the dialog, redirect to main UI
      window.location.href = window.location.href.replace('regression-popup-auto.html', 'regression-unified.html');
    }
  </script>
</body>
</html>
